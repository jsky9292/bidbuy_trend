<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÎπÑÎìúÎ∞îÏù¥ Î∂ÑÏÑù ÏãúÏä§ÌÖú</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --toss-black: #191F28;
            --toss-gray-900: #333D4B;
            --toss-gray-700: #4E5968;
            --toss-gray-600: #6B7684;
            --toss-gray-500: #8B95A1;
            --toss-gray-400: #B0B8C1;
            --toss-gray-300: #D1D6DB;
            --toss-gray-200: #E5E8EB;
            --toss-gray-100: #F2F4F6;
            --toss-gray-50: #F9FAFB;
            --toss-white: #FFFFFF;
            --toss-blue: #3182F6;
            --toss-blue-light: #E8F3FF;
            --toss-red: #F04452;
            --toss-red-light: #FFEBEE;
            --toss-green: #30B06E;
            --toss-green-light: #E8F5E9;
            --toss-yellow: #F59F00;
            --toss-yellow-light: #FFF9E6;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Pretendard', sans-serif;
            background: var(--toss-gray-50);
            color: var(--toss-black);
            line-height: 1.5;
        }
        .nav {
            position: fixed; top: 0; left: 0; right: 0; height: 56px;
            background: var(--toss-white);
            border-bottom: 1px solid var(--toss-gray-200);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px; z-index: 100;
        }
        .nav-logo { font-size: 18px; font-weight: 700; }
        .nav-logo span { color: var(--toss-blue); }
        .nav-user { display: flex; align-items: center; gap: 16px; }
        .btn-logout {
            font-size: 14px; color: var(--toss-gray-600);
            background: none; border: none; cursor: pointer;
        }
        .btn-logout:hover { color: var(--toss-red); }
        .sidebar {
            position: fixed; top: 56px; left: 0; bottom: 0; width: 240px;
            background: var(--toss-white);
            border-right: 1px solid var(--toss-gray-200);
            padding: 24px 0;
        }
        .sidebar-menu { list-style: none; }
        .sidebar-link {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 24px; font-size: 15px; color: var(--toss-gray-700);
            cursor: pointer; border: none; background: none;
            width: 100%; text-align: left; transition: all 0.15s;
        }
        .sidebar-link:hover { background: var(--toss-gray-100); }
        .sidebar-link.active {
            background: var(--toss-blue-light);
            color: var(--toss-blue); font-weight: 600;
        }
        .main {
            margin-left: 240px; margin-top: 56px;
            min-height: calc(100vh - 56px); padding: 32px;
        }
        .page-header { margin-bottom: 32px; }
        .page-title { font-size: 26px; font-weight: 700; margin-bottom: 8px; }
        .page-desc { font-size: 15px; color: var(--toss-gray-600); }
        .card {
            background: var(--toss-white);
            border-radius: 16px; padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        .card-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 20px;
        }
        .card-title { font-size: 18px; font-weight: 700; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px; margin-bottom: 24px;
        }
        .stat-card {
            background: var(--toss-white);
            border-radius: 16px; padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        .stat-label { font-size: 14px; color: var(--toss-gray-600); margin-bottom: 8px; }
        .stat-value { font-size: 28px; font-weight: 700; }
        .stat-value.blue { color: var(--toss-blue); }
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 12px 20px; font-size: 15px; font-weight: 600;
            border-radius: 12px; border: none; cursor: pointer; transition: all 0.15s;
        }
        .btn-primary { background: var(--toss-blue); color: white; }
        .btn-primary:hover { background: #2272E6; }
        .btn-primary:disabled { background: var(--toss-gray-300); cursor: not-allowed; }
        .btn-secondary { background: var(--toss-gray-100); color: var(--toss-gray-700); }
        .btn-secondary:hover { background: var(--toss-gray-200); }
        .btn-sm { padding: 8px 16px; font-size: 14px; }
        .btn-danger { background: var(--toss-red-light); color: var(--toss-red); }
        .upload-zone {
            border: 2px dashed var(--toss-gray-300);
            border-radius: 16px; padding: 48px;
            text-align: center; cursor: pointer; transition: all 0.2s;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--toss-blue);
            background: var(--toss-blue-light);
        }
        .upload-icon {
            width: 64px; height: 64px; margin: 0 auto 16px;
            background: var(--toss-gray-100); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px;
        }
        .upload-title { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
        .upload-desc { font-size: 14px; color: var(--toss-gray-600); }
        .table-wrapper { overflow-x: auto; }
        .table { width: 100%; border-collapse: collapse; }
        .table th {
            text-align: left; padding: 12px 16px;
            font-size: 13px; font-weight: 600; color: var(--toss-gray-600);
            background: var(--toss-gray-50);
            border-bottom: 1px solid var(--toss-gray-200);
        }
        .table td {
            padding: 16px; font-size: 14px;
            border-bottom: 1px solid var(--toss-gray-100);
        }
        .table tr:hover td { background: var(--toss-gray-50); }
        .badge {
            display: inline-flex; padding: 4px 10px;
            font-size: 12px; font-weight: 600; border-radius: 6px;
        }
        .badge-blue { background: var(--toss-blue-light); color: var(--toss-blue); }
        .badge-green { background: var(--toss-green-light); color: var(--toss-green); }
        .badge-red { background: var(--toss-red-light); color: var(--toss-red); }
        .badge-yellow { background: var(--toss-yellow-light); color: var(--toss-yellow); }
        .chart-container { position: relative; height: 300px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; }
        .form-input {
            width: 100%; padding: 14px 16px; font-size: 15px;
            border: 1px solid var(--toss-gray-300);
            border-radius: 12px; outline: none; transition: all 0.15s;
        }
        .form-input:focus {
            border-color: var(--toss-blue);
            box-shadow: 0 0 0 3px var(--toss-blue-light);
        }
        .form-textarea { min-height: 150px; resize: vertical; font-family: inherit; }
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236B7684' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }
        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-icon { font-size: 48px; margin-bottom: 16px; }
        .empty-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .empty-desc { font-size: 14px; color: var(--toss-gray-600); }
        .toast {
            position: fixed; bottom: 32px; left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--toss-gray-900); color: white;
            padding: 16px 24px; border-radius: 12px;
            font-size: 15px; font-weight: 500;
            opacity: 0; transition: all 0.3s; z-index: 1000;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: var(--toss-green); }
        .toast.error { background: var(--toss-red); }
        .login-container {
            min-height: 100vh; display: flex;
            align-items: center; justify-content: center;
            background: linear-gradient(135deg, #f8fafc 0%, #e8f3ff 100%);
        }
        .login-card {
            background: white; border-radius: 24px;
            padding: 48px; width: 100%; max-width: 400px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08);
        }
        .login-logo { text-align: center; margin-bottom: 40px; }
        .login-logo h1 { font-size: 28px; font-weight: 700; }
        .login-logo h1 span { color: var(--toss-blue); }
        .login-logo p { color: var(--toss-gray-600); font-size: 14px; margin-top: 8px; }
        .info-box {
            padding: 16px 20px; border-radius: 12px;
            font-size: 14px; line-height: 1.6; margin-bottom: 20px;
        }
        .info-box.blue { background: var(--toss-blue-light); color: var(--toss-blue); }
        .info-box.yellow { background: var(--toss-yellow-light); color: #996600; }
        .info-box.green { background: var(--toss-green-light); color: var(--toss-green); }
        .progress-bar {
            height: 8px; background: var(--toss-gray-100);
            border-radius: 4px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; background: var(--toss-blue);
            border-radius: 4px; transition: width 0.3s;
        }
        .chip {
            display: inline-flex; padding: 8px 16px;
            font-size: 14px; font-weight: 500;
            background: var(--toss-gray-100);
            border: none; border-radius: 20px;
            cursor: pointer; transition: all 0.15s;
        }
        .chip:hover { background: var(--toss-gray-200); }
        .chip.active { background: var(--toss-blue); color: white; }
        .data-row {
            display: flex; justify-content: space-between;
            padding: 16px 0; border-bottom: 1px solid var(--toss-gray-100);
        }
        .data-row:last-child { border-bottom: none; }
        .data-label { color: var(--toss-gray-600); }
        .data-value { font-weight: 600; }
        @media (max-width: 1024px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main { margin-left: 0; }
            .stats-grid { grid-template-columns: 1fr; }
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <div id="toast" class="toast"></div>

    <script>
        // ============================================
        // ÏÉÅÌÉú Í¥ÄÎ¶¨
        // ============================================
        const state = {
            isLoggedIn: localStorage.getItem('bidbuy_logged_in') === 'true',
            currentPage: 'dashboard',
            salesData: [], // IndexedDBÏóêÏÑú Î°úÎìú
            trendData: JSON.parse(localStorage.getItem('bidbuy_trends') || '[]'),
            newsletters: JSON.parse(localStorage.getItem('bidbuy_newsletters') || '[]'),
            subscribers: JSON.parse(localStorage.getItem('bidbuy_subscribers') || '[]'),
            geminiApiKey: localStorage.getItem('bidbuy_gemini_key') || '',
            stibeeApiKey: localStorage.getItem('bidbuy_stibee_key') || '',
            stibeeListId: localStorage.getItem('bidbuy_stibee_list') || '',
            showApiKey: false,
            showStibeeKey: false,
            isGenerating: false,
            generatedContent: '',
            newsletterHtml: '', // ÏÉùÏÑ±Îêú HTML Îâ¥Ïä§Î†àÌÑ∞
            weekInfo: { month: new Date().getMonth() + 1, week: Math.ceil(new Date().getDate() / 7) },
            charts: {},
            isLoading: true // Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë ÌëúÏãú
        };

        // ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî (TOP 30)
        if (state.trendData.length === 0) {
            state.trendData = [
                { id: 1, keyword: 'ÎØ∏Ï¶àÎÖ∏ Í∏ÄÎü¨Î∏å', category: 'ÏïºÍµ¨Ïö©Ìíà', searches: 347, change: 23, price: 15000 },
                { id: 2, keyword: 'ÏõêÌîºÏä§ ÌîºÍ∑úÏñ¥', category: 'ÌîºÍ∑úÏñ¥', searches: 282, change: 45, price: 8500 },
                { id: 3, keyword: 'ÏïÑÏãùÏä§ Î∞∞Ìä∏', category: 'ÏïºÍµ¨Ïö©Ìíà', searches: 269, change: 12, price: 25000 },
                { id: 4, keyword: 'Í±¥Îã¥ ÌîÑÎùºÎ™®Îç∏', category: 'ÌîºÍ∑úÏñ¥', searches: 228, change: 8, price: 4500 },
                { id: 5, keyword: 'Ìè¨ÏºìÎ™¨ Ïπ¥Îìú', category: 'ÌîºÍ∑úÏñ¥', searches: 217, change: 31, price: 3000 },
                { id: 6, keyword: 'ÏãúÏÑ∏Ïù¥ÎèÑ ÏÑ†ÌÅ¨Î¶º', category: 'Î∑∞Ìã∞', searches: 190, change: 18, price: 12000 },
                { id: 7, keyword: 'SK-II ÏóêÏÑºÏä§', category: 'Î∑∞Ìã∞', searches: 183, change: 15, price: 45000 },
                { id: 8, keyword: 'ÏπºÎπÑ Í∞êÏûêÏπ©', category: 'ÏãùÌíà', searches: 172, change: -5, price: 2500 },
                { id: 9, keyword: 'Ïú†ÎãàÌÅ¥Î°ú ÌûàÌä∏ÌÖç', category: 'ÏÉùÌôú', searches: 142, change: 67, price: 8000 },
                { id: 10, keyword: 'Î¨¥Ïù∏ÏñëÌíà Î¨∏Íµ¨', category: 'ÏÉùÌôú', searches: 139, change: 12, price: 3500 },
                { id: 11, keyword: 'ÎÇòÏù¥ÌÇ§ Îç©ÌÅ¨', category: 'Ìå®ÏÖò', searches: 135, change: 28, price: 35000 },
                { id: 12, keyword: 'ÏÜåÎãà Ïù¥Ïñ¥Ìè∞', category: 'Ï†ÑÏûêÍ∏∞Í∏∞', searches: 128, change: 19, price: 28000 },
                { id: 13, keyword: 'ÎãåÌÖêÎèÑ Ïä§ÏúÑÏπò', category: 'Í≤åÏûÑ', searches: 124, change: 8, price: 85000 },
                { id: 14, keyword: 'Îã§Ïù¥ÏÜå Ï£ºÎ∞©Ïö©Ìíà', category: 'ÏÉùÌôú', searches: 118, change: 5, price: 1500 },
                { id: 15, keyword: 'ÏïÑÎîîÎã§Ïä§ ÏÇºÎ∞î', category: 'Ìå®ÏÖò', searches: 112, change: 42, price: 32000 },
                { id: 16, keyword: 'Ï∫êÎÖº Ïπ¥Î©îÎùº', category: 'Ï†ÑÏûêÍ∏∞Í∏∞', searches: 108, change: -3, price: 120000 },
                { id: 17, keyword: 'Î†àÍ≥† ÌÅ¥ÎûòÏãù', category: 'ÏôÑÍµ¨', searches: 105, change: 14, price: 15000 },
                { id: 18, keyword: 'ÏÇ∞Î¶¨Ïò§ ÍµøÏ¶à', category: 'Ï∫êÎ¶≠ÌÑ∞', searches: 98, change: 56, price: 5000 },
                { id: 19, keyword: 'ÏïÑÏù¥Î¶¨Î≤Ñ MP3', category: 'Ï†ÑÏûêÍ∏∞Í∏∞', searches: 92, change: -12, price: 18000 },
                { id: 20, keyword: 'Î∞òÎã§Ïù¥ ÌÉÄÎßàÍ≥†Ïπò', category: 'ÏôÑÍµ¨', searches: 88, change: 33, price: 6500 },
                { id: 21, keyword: 'ÏΩîÏÑ∏ ÌôîÏû•Ìíà', category: 'Î∑∞Ìã∞', searches: 85, change: 7, price: 22000 },
                { id: 22, keyword: 'ÏïÑÏÇ¨Ìûà Îß•Ï£º', category: 'ÏãùÌíà', searches: 82, change: 4, price: 4500 },
                { id: 23, keyword: 'Îâ¥Î∞úÎûÄÏä§ 993', category: 'Ìå®ÏÖò', searches: 79, change: 25, price: 48000 },
                { id: 24, keyword: 'ÌååÎÇòÏÜåÎãâ Î©¥ÎèÑÍ∏∞', category: 'ÏÉùÌôú', searches: 75, change: 9, price: 35000 },
                { id: 25, keyword: 'ÏöîÎÑ•Ïä§ ÎùºÏºì', category: 'Ïä§Ìè¨Ï∏†', searches: 72, change: 11, price: 42000 },
                { id: 26, keyword: 'ÏßÄÎ∏åÎ¶¨ DVD', category: 'ÎØ∏ÎîîÏñ¥', searches: 68, change: 6, price: 8000 },
                { id: 27, keyword: 'Î¨¥ÏßÄ ÎÖ∏Ìä∏', category: 'Î¨∏Íµ¨', searches: 65, change: 3, price: 2000 },
                { id: 28, keyword: 'ÏïÑÏù¥ÏΩîÏä§ ÏºÄÏù¥Ïä§', category: 'ÏÉùÌôú', searches: 62, change: -8, price: 4000 },
                { id: 29, keyword: 'Ïπ¥ÏãúÏò§ ÏãúÍ≥Ñ', category: 'Ìå®ÏÖò', searches: 58, change: 15, price: 25000 },
                { id: 30, keyword: 'ÏÑ∏Ïù¥ÏΩî ÏãúÍ≥Ñ', category: 'Ìå®ÏÖò', searches: 55, change: 10, price: 65000 },
            ];
        }

        if (state.subscribers.length === 0) {
            state.subscribers = [
                { id: 1, email: 'user1@example.com', name: 'ÍπÄÏ≤†Ïàò', subscribed: true, createdAt: '2025-11-01' },
                { id: 2, email: 'user2@example.com', name: 'Ïù¥ÏòÅÌù¨', subscribed: true, createdAt: '2025-11-15' },
            ];
        }

        // ============================================
        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò
        // ============================================
        function showToast(msg, type = 'default') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show';
            if (type === 'success') t.classList.add('success');
            if (type === 'error') t.classList.add('error');
            // ÏóêÎü¨Îäî 5Ï¥à, ÎÇòÎ®∏ÏßÄÎäî 3Ï¥à
            const duration = type === 'error' ? 5000 : 3000;
            setTimeout(() => { t.className = 'toast'; }, duration);
            // ÏΩòÏÜîÏóêÎèÑ Í∏∞Î°ù
            console.log(`[Toast ${type}] ${msg}`);
        }

        function formatNumber(n) {
            return new Intl.NumberFormat('ko-KR').format(n || 0);
        }

        function formatCurrency(n, unit = '¬•') {
            return unit + new Intl.NumberFormat('ko-KR').format(n || 0);
        }

        function formatKRW(n) {
            return new Intl.NumberFormat('ko-KR').format(n || 0) + 'Ïõê';
        }

        // ============================================
        // IndexedDB Ï†ÄÏû•ÏÜå (ÎåÄÏö©Îüâ Îç∞Ïù¥ÌÑ∞Ïö©)
        // ============================================
        const DB_NAME = 'BidBuyAnalytics';
        const DB_VERSION = 2; // Î≤ÑÏ†Ñ ÏóÖÍ∑∏Î†àÏù¥Îìú
        let db = null;

        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => {
                    console.error('‚ùå IndexedDB Ïó¥Í∏∞ Ïã§Ìå®:', request.error);
                    reject(request.error);
                };

                request.onsuccess = () => {
                    db = request.result;
                    console.log('‚úÖ IndexedDB Ïó∞Í≤∞Îê® (v' + DB_VERSION + ')');
                    resolve(db);
                };

                request.onupgradeneeded = (e) => {
                    const database = e.target.result;
                    console.log('üîÑ IndexedDB ÏóÖÍ∑∏Î†àÏù¥Îìú Ï§ë... v' + e.oldVersion + ' ‚Üí v' + DB_VERSION);

                    // Í∏∞Ï°¥ Ïä§ÌÜ†Ïñ¥ ÏÇ≠Ï†ú ÌõÑ Ïû¨ÏÉùÏÑ±
                    if (database.objectStoreNames.contains('salesData')) {
                        database.deleteObjectStore('salesData');
                    }
                    if (database.objectStoreNames.contains('metadata')) {
                        database.deleteObjectStore('metadata');
                    }

                    // ÏÉà Ïä§ÌÜ†Ïñ¥ ÏÉùÏÑ± (autoIncrement ÏÇ¨Ïö©)
                    database.createObjectStore('salesData', { autoIncrement: true });
                    database.createObjectStore('metadata', { keyPath: 'key' });

                    console.log('üì¶ IndexedDB Ïä§ÌÜ†Ïñ¥ Ïû¨ÏÉùÏÑ±Îê®');
                };
            });
        }

        // IndexedDB ÏôÑÏ†Ñ ÏÇ≠Ï†ú (Î¨∏Ï†ú Ìï¥Í≤∞Ïö©)
        async function resetDB() {
            return new Promise((resolve, reject) => {
                if (db) db.close();
                const request = indexedDB.deleteDatabase(DB_NAME);
                request.onsuccess = () => {
                    console.log('üóëÔ∏è IndexedDB ÏôÑÏ†Ñ ÏÇ≠Ï†úÎê®');
                    db = null;
                    resolve();
                };
                request.onerror = () => reject(request.error);
            });
        }

        // ÌåêÎß§ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (IndexedDB) - Ï≤≠ÌÅ¨ Îã®ÏúÑ Ï†ÄÏû•
        async function saveSalesData(data) {
            if (!db) await initDB();

            if (!data || data.length === 0) {
                // Îπà Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (ÏÇ≠Ï†ú)
                const transaction = db.transaction(['salesData'], 'readwrite');
                transaction.objectStore('salesData').clear();
                return;
            }

            const CHUNK_SIZE = 1000; // 1000Í±¥Ïî© Ï†ÄÏû• (Îçî ÏïàÏ†ïÏ†Å)
            const totalChunks = Math.ceil(data.length / CHUNK_SIZE);

            console.log(`üì¶ Ï¥ù ${formatNumber(data.length)}Í±¥ÏùÑ ${totalChunks}Í∞ú Ï≤≠ÌÅ¨Î°ú Ï†ÄÏû• ÏãúÏûë...`);

            // Î®ºÏ†Ä Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
            await new Promise((resolve, reject) => {
                const transaction = db.transaction(['salesData'], 'readwrite');
                const store = transaction.objectStore('salesData');
                const clearRequest = store.clear();
                clearRequest.onsuccess = () => {
                    console.log('üóëÔ∏è Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú ÏôÑÎ£å');
                    resolve();
                };
                clearRequest.onerror = (e) => {
                    console.error('ÏÇ≠Ï†ú Ïã§Ìå®:', e);
                    reject(e);
                };
            });

            // Ï≤≠ÌÅ¨ Îã®ÏúÑÎ°ú Ï†ÄÏû•
            let savedCount = 0;
            for (let i = 0; i < totalChunks; i++) {
                const start = i * CHUNK_SIZE;
                const end = Math.min(start + CHUNK_SIZE, data.length);
                const chunk = data.slice(start, end);

                await new Promise((resolve, reject) => {
                    const transaction = db.transaction(['salesData'], 'readwrite');
                    const store = transaction.objectStore('salesData');

                    let addedCount = 0;
                    chunk.forEach((item) => {
                        const request = store.add(item);
                        request.onsuccess = () => addedCount++;
                        request.onerror = (e) => console.warn('Ìï≠Î™© Ï∂îÍ∞Ä Ïã§Ìå®:', e.target.error);
                    });

                    transaction.oncomplete = () => {
                        savedCount += addedCount;
                        const progress = Math.round((savedCount / data.length) * 100);
                        if (i % 5 === 0 || i === totalChunks - 1) {
                            console.log(`üìä Ï†ÄÏû• ÏßÑÌñâ: ${progress}% (${formatNumber(savedCount)}/${formatNumber(data.length)}Í±¥)`);
                        }
                        resolve();
                    };

                    transaction.onerror = (e) => {
                        console.error(`‚ùå Ï≤≠ÌÅ¨ ${i + 1} Ï†ÄÏû• Ïã§Ìå®:`, e.target.error);
                        // ÏóêÎü¨Í∞Ä ÎÇòÎèÑ Í≥ÑÏÜç ÏßÑÌñâ
                        resolve();
                    };
                });
            }

            console.log(`‚úÖ IndexedDBÏóê ${formatNumber(savedCount)}Í±¥ Ï†ÄÏû• ÏôÑÎ£å`);
            await saveMetadata('salesCount', savedCount);
            return savedCount;
        }

        // ÌåêÎß§ Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ (IndexedDB)
        async function loadSalesData() {
            if (!db) await initDB();

            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['salesData'], 'readonly');
                const store = transaction.objectStore('salesData');
                const request = store.getAll();

                request.onsuccess = () => {
                    const data = request.result || [];
                    console.log(`üìÇ IndexedDBÏóêÏÑú ${data.length}Í±¥ Î°úÎìúÎê®`);
                    resolve(data);
                };

                request.onerror = () => {
                    console.error('‚ùå IndexedDB Î°úÎìú Ïã§Ìå®');
                    reject(request.error);
                };
            });
        }

        // Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        async function saveMetadata(key, value) {
            if (!db) await initDB();

            return new Promise((resolve) => {
                const transaction = db.transaction(['metadata'], 'readwrite');
                const store = transaction.objectStore('metadata');
                store.put({ key, value });
                transaction.oncomplete = () => resolve();
            });
        }

        // Í∏∞Ï°¥ localStorage Ìï®Ïàò (Ìä∏Î†åÎìú, Îâ¥Ïä§Î†àÌÑ∞ Îì± ÏÜåÎüâ Îç∞Ïù¥ÌÑ∞Ïö©)
        function saveState() {
            // ÌåêÎß§ Îç∞Ïù¥ÌÑ∞Îäî IndexedDBÏóê Ï†ÄÏû•ÌïòÎØÄÎ°ú Ïó¨Í∏∞ÏÑú Ï†úÏô∏
            localStorage.setItem('bidbuy_trends', JSON.stringify(state.trendData));
            localStorage.setItem('bidbuy_newsletters', JSON.stringify(state.newsletters));
            localStorage.setItem('bidbuy_subscribers', JSON.stringify(state.subscribers));
        }

        // ÌåêÎß§ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• (ÎåÄÏö©Îüâ)
        async function saveSalesState() {
            try {
                await saveSalesData(state.salesData);
                showToast(`‚úÖ ${formatNumber(state.salesData.length)}Í±¥ Ï†ÄÏû• ÏôÑÎ£å`, 'success');
            } catch (err) {
                console.error('Ï†ÄÏû• Ïã§Ìå®:', err);
                showToast('Ï†ÄÏû• Ïã§Ìå®: ' + err.message, 'error');
            }
        }

        function destroyCharts() {
            Object.values(state.charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            state.charts = {};
        }

        // ============================================
        // ÏóëÏÖÄ ÌååÏã±
        // ============================================
        async function parseExcel(file) {
            return new Promise((resolve, reject) => {
                console.log('üìÅ ÌååÏùº Ï†ïÎ≥¥:', {
                    name: file.name,
                    size: (file.size / 1024 / 1024).toFixed(2) + 'MB',
                    type: file.type
                });

                // XLSX ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìú ÌôïÏù∏
                if (typeof XLSX === 'undefined') {
                    console.error('‚ùå XLSX ÎùºÏù¥Î∏åÎü¨Î¶¨ ÎØ∏Î°úÎìú');
                    reject(new Error('ÏóëÏÖÄ ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎî© Ï§ëÏûÖÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.'));
                    return;
                }
                console.log('‚úÖ XLSX ÎùºÏù¥Î∏åÎü¨Î¶¨ Î°úÎìúÎê®');

                const reader = new FileReader();

                reader.onload = (e) => {
                    console.log('üìñ ÌååÏùº ÏùΩÍ∏∞ ÏôÑÎ£å, ÌååÏã± ÏãúÏûë...');
                    try {
                        if (!e.target.result) {
                            reject(new Error('ÌååÏùº ÎÇ¥Ïö©Ïù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.'));
                            return;
                        }

                        const data = new Uint8Array(e.target.result);
                        console.log('üìä Îç∞Ïù¥ÌÑ∞ ÌÅ¨Í∏∞:', data.length, 'bytes');

                        if (data.length === 0) {
                            reject(new Error('ÌååÏùºÏù¥ ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.'));
                            return;
                        }

                        console.log('üîÑ XLSX.read ÏãúÏûë...');
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                        console.log('üìó ÏõåÌÅ¨Î∂Å ÏãúÌä∏:', workbook.SheetNames);

                        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                            reject(new Error('ÏãúÌä∏Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. ÌååÏùºÏù¥ ÏÜêÏÉÅÎêòÏóàÏùÑ Ïàò ÏûàÏäµÎãàÎã§.'));
                            return;
                        }

                        const sheetName = workbook.SheetNames[0];
                        const sheet = workbook.Sheets[sheetName];
                        console.log('üìÑ Ï≤´ Î≤àÏß∏ ÏãúÌä∏:', sheetName);

                        if (!sheet) {
                            reject(new Error('ÏãúÌä∏ Îç∞Ïù¥ÌÑ∞Î•º ÏùΩÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.'));
                            return;
                        }

                        console.log('üîÑ JSON Î≥ÄÌôò ÏãúÏûë...');
                        const json = XLSX.utils.sheet_to_json(sheet, { defval: '' });
                        console.log('‚úÖ ÌååÏã± ÏôÑÎ£å, Ìñâ Ïàò:', json.length);

                        if (json.length > 0) {
                            console.log('üìã Ïª¨Îüº Î™©Î°ù:', Object.keys(json[0]));
                            console.log('üìã Ï≤´ Î≤àÏß∏ Ìñâ ÏÉòÌîå:', JSON.stringify(json[0]).substring(0, 200));
                        }

                        if (!json || json.length === 0) {
                            reject(new Error('Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. Ï≤´ ÌñâÏù¥ Ìó§ÎçîÏù∏ÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.'));
                            return;
                        }

                        resolve(json);
                    } catch (err) {
                        console.error('‚ùå Excel parse error:', err);
                        console.error('‚ùå ÏóêÎü¨ Ïä§ÌÉù:', err.stack);
                        reject(new Error('ÌååÏùº ÌååÏã± Ïò§Î•ò: ' + (err.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò')));
                    }
                };

                reader.onerror = (err) => {
                    console.error('‚ùå FileReader error:', err);
                    reject(new Error('ÌååÏùºÏùÑ ÏùΩÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.'));
                };

                reader.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        console.log('üì• ÏùΩÍ∏∞ ÏßÑÌñâ:', percent + '%');
                    }
                };

                console.log('üìÇ ÌååÏùº ÏùΩÍ∏∞ ÏãúÏûë...');
                reader.readAsArrayBuffer(file);
            });
        }

        // ============================================
        // Ïä§ÎßàÌä∏ Ïª¨Îüº Îß§Ìïë (Í≥ÑÏ∏µÏ†Å Ïπ¥ÌÖåÍ≥†Î¶¨ ÏßÄÏõê)
        // ============================================
        const columnMapping = {
            category1: null,  // ÎåÄÎ∂ÑÎ•ò (depth1)
            category2: null,  // Ï§ëÎ∂ÑÎ•ò (depth2)
            category3: null,  // ÏÜåÎ∂ÑÎ•ò (depth3)
            category4: null,  // ÏÑ∏Î∂ÄÎ∂ÑÎ•ò (depth4)
            sales: null,      // ÌåêÎß§Í∏àÏï° Ïª¨Îüº
            quantity: null,   // ÌåêÎß§ÏàòÎüâ Ïª¨Îüº
            product: null,    // ÏÉÅÌíàÎ™Ö Ïª¨Îüº
            date: null,       // ÎÇ†Ïßú Ïª¨Îüº
            site: null        // ÏÇ¨Ïù¥Ìä∏ Ïª¨Îüº
        };

        // ÌòÑÏû¨ Î∂ÑÏÑùÏóê ÏÇ¨Ïö©Ìï† Ïπ¥ÌÖåÍ≥†Î¶¨ depth (1~4)
        let analysisCategoryDepth = 1;

        // ÏõîÎ≥Ñ ÌïÑÌÑ∞ (null = Ï†ÑÏ≤¥, '2025-08' ÌòïÏãù)
        let selectedMonth = null;

        // ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïõî Î™©Î°ù Ï∂îÏ∂ú
        function getAvailableMonths() {
            if (!state.salesData || state.salesData.length === 0) return [];

            const months = new Set();
            const dateCol = columnMapping.date;

            state.salesData.forEach(item => {
                let dateVal = dateCol ? item[dateCol] : item['Í≤∞Ï†úÏùº'];
                if (!dateVal) return;

                // ÎÇ†Ïßú ÌååÏã±
                let date;
                if (dateVal instanceof Date) {
                    date = dateVal;
                } else if (typeof dateVal === 'number') {
                    // Excel ÎÇ†Ïßú ÏãúÎ¶¨Ïñº
                    date = new Date((dateVal - 25569) * 86400 * 1000);
                } else if (typeof dateVal === 'string') {
                    date = new Date(dateVal);
                }

                if (date && !isNaN(date.getTime())) {
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    months.add(monthKey);
                }
            });

            return Array.from(months).sort();
        }

        // ÌïÑÌÑ∞ÎßÅÎêú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        function getFilteredData() {
            if (!selectedMonth) return state.salesData;

            const dateCol = columnMapping.date;
            return state.salesData.filter(item => {
                let dateVal = dateCol ? item[dateCol] : item['Í≤∞Ï†úÏùº'];
                if (!dateVal) return false;

                let date;
                if (dateVal instanceof Date) {
                    date = dateVal;
                } else if (typeof dateVal === 'number') {
                    date = new Date((dateVal - 25569) * 86400 * 1000);
                } else if (typeof dateVal === 'string') {
                    date = new Date(dateVal);
                }

                if (date && !isNaN(date.getTime())) {
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    return monthKey === selectedMonth;
                }
                return false;
            });
        }

        // Ïª¨Îüº ÏûêÎèô Í∞êÏßÄ (Í≥ÑÏ∏µÏ†Å Ïπ¥ÌÖåÍ≥†Î¶¨ ÏßÄÏõê)
        function detectColumns(data) {
            if (!data || data.length === 0) return;

            const firstRow = data[0];
            const columns = Object.keys(firstRow);
            console.log('üìã Í∞êÏßÄÎêú Ïª¨Îüº:', columns);
            console.log('üìã Ï≤´ Î≤àÏß∏ Ìñâ Îç∞Ïù¥ÌÑ∞:', firstRow);

            // Í≥ÑÏ∏µÏ†Å Ïπ¥ÌÖåÍ≥†Î¶¨ Ïª¨Îüº Ï∞æÍ∏∞ (Ïπ¥ÌÖåÍ≥†Î¶¨1~9)
            columnMapping.category1 = columns.find(col => col.trim() === 'Ïπ¥ÌÖåÍ≥†Î¶¨1') || null;
            columnMapping.category2 = columns.find(col => col.trim() === 'Ïπ¥ÌÖåÍ≥†Î¶¨2') || null;
            columnMapping.category3 = columns.find(col => col.trim() === 'Ïπ¥ÌÖåÍ≥†Î¶¨3') || null;
            columnMapping.category4 = columns.find(col => col.trim() === 'Ïπ¥ÌÖåÍ≥†Î¶¨4') || null;

            // Ïπ¥ÌÖåÍ≥†Î¶¨1Ïù¥ ÏóÜÏúºÎ©¥ ÏùºÎ∞ò Ìå®ÌÑ¥ÏúºÎ°ú Í≤ÄÏÉâ
            if (!columnMapping.category1) {
                const categoryPatterns = ['Ïπ¥ÌÖåÍ≥†Î¶¨', 'category', 'Category', 'Î∂ÑÎ•ò', 'ÎåÄÎ∂ÑÎ•ò'];
                columnMapping.category1 = columns.find(col => categoryPatterns.some(p => col.toLowerCase().includes(p.toLowerCase()))) || null;
            }

            // ÌåêÎß§Í∏àÏï° Ïª¨Îüº Ï∞æÍ∏∞ (ÏÉÅÌíàÍ∞Ä Ïö∞ÏÑ†)
            columnMapping.sales = columns.find(col => col.trim() === 'ÏÉÅÌíàÍ∞Ä') ||
                                  columns.find(col => ['ÌåêÎß§Í∏àÏï°', 'Í∏àÏï°', 'sales', 'price', 'Í∞ÄÍ≤©', 'ÎÇôÏ∞∞Í∞Ä'].some(p => col.toLowerCase().includes(p.toLowerCase()))) || null;

            // ÌåêÎß§ÏàòÎüâ Ïª¨Îüº Ï∞æÍ∏∞
            columnMapping.quantity = columns.find(col => ['ÌåêÎß§ÏàòÎüâ', 'ÏàòÎüâ', 'quantity', 'qty', 'Í∞úÏàò'].some(p => col.toLowerCase().includes(p.toLowerCase()))) || null;

            // ÏÉÅÌíàÎ™Ö Ïª¨Îüº Ï∞æÍ∏∞
            columnMapping.product = columns.find(col => col.trim() === 'ÏÉÅÌíàÎ™Ö') ||
                                    columns.find(col => ['ÏÉÅÌíà', 'product', 'ÌíàÎ™Ö', 'name', 'Ï†úÌíàÎ™Ö'].some(p => col.toLowerCase().includes(p.toLowerCase()))) || null;

            // ÎÇ†Ïßú Ïª¨Îüº Ï∞æÍ∏∞
            columnMapping.date = columns.find(col => col.trim() === 'Í≤∞Ï†úÏùº') ||
                                 columns.find(col => ['ÎÇ†Ïßú', 'date', 'ÏùºÏûê', 'Ï£ºÎ¨∏Ïùº'].some(p => col.toLowerCase().includes(p.toLowerCase()))) || null;

            // ÏÇ¨Ïù¥Ìä∏ Ïª¨Îüº Ï∞æÍ∏∞
            columnMapping.site = columns.find(col => col.trim() === 'ÏÇ¨Ïù¥Ìä∏') ||
                                 columns.find(col => ['site', 'ÌîåÎû´Ìèº', 'Ï∂úÏ≤ò'].some(p => col.toLowerCase().includes(p.toLowerCase()))) || null;

            console.log('üîó Ïª¨Îüº Îß§Ìïë Í≤∞Í≥º:', columnMapping);

            // Îß§Ìïë Í≤∞Í≥º Ï†ÄÏû•
            localStorage.setItem('bidbuy_column_mapping', JSON.stringify(columnMapping));

            return columnMapping;
        }

        // Ï†ÄÏû•Îêú Îß§Ìïë Î∂àÎü¨Ïò§Í∏∞
        function loadColumnMapping() {
            const saved = localStorage.getItem('bidbuy_column_mapping');
            if (saved) {
                Object.assign(columnMapping, JSON.parse(saved));
            }
        }
        loadColumnMapping();

        // Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Í∞í Ï∂îÏ∂ú (Îß§Ìïë ÏÇ¨Ïö©) - Í≥ÑÏ∏µÏ†Å Ïπ¥ÌÖåÍ≥†Î¶¨ ÏßÄÏõê
        function getValue(item, type, depth = null) {
            // Ïπ¥ÌÖåÍ≥†Î¶¨ ÏöîÏ≤≠ Ïãú depthÏóê Îî∞Îùº Ï†ÅÏ†àÌïú Ïª¨Îüº Î∞òÌôò
            if (type === 'category') {
                const targetDepth = depth || analysisCategoryDepth;
                const catCol = columnMapping[`category${targetDepth}`];
                if (catCol && item[catCol] !== undefined && item[catCol] !== null && item[catCol] !== '') {
                    return item[catCol];
                }
                // depth 1Î∂ÄÌÑ∞ ÏàúÏ∞®Ï†ÅÏúºÎ°ú Ìè¥Î∞±
                for (let d = 1; d <= 4; d++) {
                    const col = columnMapping[`category${d}`];
                    if (col && item[col] !== undefined && item[col] !== null && item[col] !== '') {
                        return item[col];
                    }
                }
            }

            const col = columnMapping[type];
            if (col && item[col] !== undefined) {
                return item[col];
            }
            // Ìè¥Î∞±: ÏßÅÏ†ë Îß§Ïπ≠ ÏãúÎèÑ
            const fallbacks = {
                category1: ['Ïπ¥ÌÖåÍ≥†Î¶¨1', 'ÎåÄÎ∂ÑÎ•ò'],
                category2: ['Ïπ¥ÌÖåÍ≥†Î¶¨2', 'Ï§ëÎ∂ÑÎ•ò'],
                category3: ['Ïπ¥ÌÖåÍ≥†Î¶¨3', 'ÏÜåÎ∂ÑÎ•ò'],
                category4: ['Ïπ¥ÌÖåÍ≥†Î¶¨4', 'ÏÑ∏Î∂ÄÎ∂ÑÎ•ò'],
                sales: ['ÏÉÅÌíàÍ∞Ä', 'ÌåêÎß§Í∏àÏï°', 'Í∏àÏï°', 'sales', 'Sales', 'amount', 'Í∞ÄÍ≤©'],
                quantity: ['ÌåêÎß§ÏàòÎüâ', 'ÏàòÎüâ', 'quantity', 'Quantity', 'qty'],
                product: ['ÏÉÅÌíàÎ™Ö', 'ÏÉÅÌíà', 'product', 'Product', 'ÌíàÎ™Ö'],
                date: ['Í≤∞Ï†úÏùº', 'ÎÇ†Ïßú', 'date', 'Date', 'ÏùºÏûê'],
                site: ['ÏÇ¨Ïù¥Ìä∏', 'site', 'ÌîåÎû´Ìèº']
            };
            for (const key of (fallbacks[type] || [])) {
                if (item[key] !== undefined) return item[key];
            }
            return null;
        }

        // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ÏóêÏÑú TOP 30 Ìä∏Î†åÎìú ÌÇ§ÏõåÎìú Ï∂îÏ∂ú (ÏõîÎ≥Ñ ÌïÑÌÑ∞ Ï†ÅÏö©)
        function extractTrendFromData() {
            // ÏõîÎ≥Ñ ÌïÑÌÑ∞ Ï†ÅÏö©Îêú Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
            const filteredData = getFilteredData();

            if (!filteredData || filteredData.length === 0) {
                console.log('üìä Ìä∏Î†åÎìú Ï∂îÏ∂ú: Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå');
                return [];
            }

            console.log('üìä Ìä∏Î†åÎìú Ï∂îÏ∂ú ÏãúÏûë - ÌïÑÌÑ∞ Ï†ÅÏö© Îç∞Ïù¥ÌÑ∞:', filteredData.length, 'Í±¥', '(ÏÑ†ÌÉù Ïõî:', selectedMonth || 'Ï†ÑÏ≤¥', ')');

            // Ïπ¥ÌÖåÍ≥†Î¶¨4 (ÏÑ∏Î∂ÄÎ∂ÑÎ•ò) Í∏∞Ï§ÄÏúºÎ°ú ÏßëÍ≥Ñ
            const keywordStats = {};

            filteredData.forEach(item => {
                // depth 4 (ÏÑ∏Î∂ÄÎ∂ÑÎ•ò) Ïö∞ÏÑ†, ÏóÜÏúºÎ©¥ depth 3, 2, 1 ÏàúÏÑú
                let keyword = null;
                for (let d = 4; d >= 1; d--) {
                    const catCol = columnMapping[`category${d}`];
                    if (catCol && item[catCol] && item[catCol].trim() !== '') {
                        keyword = item[catCol].trim();
                        break;
                    }
                }

                if (!keyword || keyword === '') return;

                // ÏÉÅÏúÑ Ïπ¥ÌÖåÍ≥†Î¶¨ (depth 1) Ï∞æÍ∏∞ - ÏâºÌëú+Í≥µÎ∞± ÌÜµÏùº
                const cat1Col = columnMapping.category1;
                let parentCategory = cat1Col ? (item[cat1Col] || 'Í∏∞ÌÉÄ') : 'Í∏∞ÌÉÄ';
                // ÏâºÌëú Îí§ Í≥µÎ∞± ÌÜµÏùº Ï≤òÎ¶¨
                if (typeof parentCategory === 'string') {
                    parentCategory = parentCategory.replace(/,\s*/g, ', ').trim();
                }

                // ÌåêÎß§Í∏àÏï° ÌååÏã±
                let salesVal = getValue(item, 'sales');
                if (typeof salesVal === 'string') {
                    salesVal = salesVal.replace(/[,\s¬•Ôø•Ïõê]/g, '');
                }
                const sales = parseFloat(salesVal) || 0;

                if (!keywordStats[keyword]) {
                    keywordStats[keyword] = {
                        keyword,
                        category: parentCategory,
                        count: 0,
                        totalSales: 0
                    };
                }
                keywordStats[keyword].count++;
                keywordStats[keyword].totalSales += sales;
            });

            // TOP 30 Ï∂îÏ∂ú (Í±∞Îûò Í±¥Ïàò Í∏∞Ï§Ä Ï†ïÎ†¨)
            const sorted = Object.values(keywordStats)
                .sort((a, b) => b.count - a.count)
                .slice(0, 30);

            // trendData ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
            const trendData = sorted.map((item, index) => ({
                id: index + 1,
                keyword: item.keyword,
                category: item.category,
                searches: item.count, // Í±∞Îûò Í±¥ÏàòÎ•º Í≤ÄÏÉâÎüâÏúºÎ°ú ÏÇ¨Ïö©
                change: Math.floor(Math.random() * 40) - 10, // ÏûÑÏãú: Î≥ÄÌôîÏú®ÏùÄ ÎûúÎç§ (-10% ~ +30%)
                price: Math.round(item.totalSales / item.count) // ÌèâÍ∑† Îã®Í∞Ä
            }));

            console.log('üìä Ìä∏Î†åÎìú Ï∂îÏ∂ú ÏôÑÎ£å:', trendData.length, 'Í∞ú ÌÇ§ÏõåÎìú');
            console.log('üìä TOP 5:', trendData.slice(0, 5).map(t => `${t.keyword}(${t.searches}Í±¥)`).join(', '));

            return trendData;
        }

        // ============================================
        // Ïπ¥ÌÖåÍ≥†Î¶¨ Î∂ÑÏÑù (Í≥ÑÏ∏µÏ†Å Î∂ÑÏÑù ÏßÄÏõê + ÏõîÎ≥Ñ ÌïÑÌÑ∞)
        // ============================================
        function analyzeCategories(depth = null) {
            const targetDepth = depth || analysisCategoryDepth;
            const stats = {};
            let totalSales = 0, totalQty = 0;
            const products = {}; // ÏÉÅÌíàÎ≥Ñ ÏßëÍ≥Ñ
            const siteStats = {}; // ÏÇ¨Ïù¥Ìä∏Î≥Ñ ÏßëÍ≥Ñ

            // ÏõîÎ≥Ñ ÌïÑÌÑ∞ Ï†ÅÏö©Îêú Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
            const filteredData = getFilteredData();

            // Ï≤´ Î≤àÏß∏ Îç∞Ïù¥ÌÑ∞Î°ú ÎîîÎ≤ÑÍ∑∏ (Ìïú Î≤àÎßå)
            if (filteredData.length > 0 && !window._analyzedOnce) {
                window._analyzedOnce = true;
                console.log('üîç Î∂ÑÏÑù ÏãúÏûë - Ï¥ù Îç∞Ïù¥ÌÑ∞:', state.salesData.length, 'Í±¥, ÌïÑÌÑ∞ Ï†ÅÏö©:', filteredData.length, 'Í±¥');
                console.log('üìã Ïª¨Îüº Îß§Ìïë:', columnMapping);
                console.log('üìã Î∂ÑÏÑù ÍπäÏù¥:', targetDepth);
                console.log('üìã ÏÑ†ÌÉù Ïõî:', selectedMonth || 'Ï†ÑÏ≤¥');
                console.log('üìù Ï≤´ Î≤àÏß∏ Îç∞Ïù¥ÌÑ∞ ÏÉòÌîå:', filteredData[0]);
                console.log('üìù Ï∂îÏ∂úÎêú Í∞í ÏÉòÌîå:', {
                    category1: getValue(filteredData[0], 'category', 1),
                    category2: getValue(filteredData[0], 'category', 2),
                    category3: getValue(filteredData[0], 'category', 3),
                    category4: getValue(filteredData[0], 'category', 4),
                    sales: getValue(filteredData[0], 'sales'),
                    product: getValue(state.salesData[0], 'product'),
                    site: getValue(state.salesData[0], 'site')
                });
            }

            filteredData.forEach(item => {
                // ÏßÄÏ†ïÎêú depthÏùò Ïπ¥ÌÖåÍ≥†Î¶¨ Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
                const cat = getValue(item, 'category', targetDepth) || 'ÎØ∏Î∂ÑÎ•ò';

                // Ïà´Ïûê ÌååÏã± Í∞úÏÑ†: ÏâºÌëú, Í≥µÎ∞± Îì± Ï†úÍ±∞
                let salesVal = getValue(item, 'sales');
                if (typeof salesVal === 'string') {
                    salesVal = salesVal.replace(/[,\s¬•Ôø•Ïõê]/g, '');
                }
                const sales = parseFloat(salesVal) || 0;
                const qty = parseInt(getValue(item, 'quantity')) || 1;
                const product = getValue(item, 'product') || '';
                const site = getValue(item, 'site') || 'Í∏∞ÌÉÄ';

                // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏßëÍ≥Ñ
                if (!stats[cat]) stats[cat] = { sales: 0, quantity: 0, count: 0, avgPrice: 0 };
                stats[cat].sales += sales;
                stats[cat].quantity += qty;
                stats[cat].count++;
                totalSales += sales;
                totalQty++; // Í±∞ÎûòÍ±¥ÏàòÎ°ú Í≥ÑÏÇ∞

                // ÏÇ¨Ïù¥Ìä∏Î≥Ñ ÏßëÍ≥Ñ
                if (!siteStats[site]) siteStats[site] = { sales: 0, count: 0 };
                siteStats[site].sales += sales;
                siteStats[site].count++;

                // ÏÉÅÌíàÎ≥Ñ ÏßëÍ≥Ñ
                if (product) {
                    if (!products[product]) products[product] = { sales: 0, quantity: 0, category: cat, count: 0 };
                    products[product].sales += sales;
                    products[product].quantity += qty;
                    products[product].count++;
                }
            });

            // ÎπÑÏú® Î∞è ÌèâÍ∑† Í≥ÑÏÇ∞
            Object.keys(stats).forEach(cat => {
                stats[cat].ratio = totalSales > 0 ? (stats[cat].sales / totalSales * 100).toFixed(1) : 0;
                stats[cat].avgPrice = stats[cat].count > 0 ? Math.round(stats[cat].sales / stats[cat].count) : 0;
            });

            // TOP 10 ÏÉÅÌíà (ÌåêÎß§Í∏àÏï° Í∏∞Ï§Ä)
            const topProducts = Object.entries(products)
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 10)
                .map(([name, data]) => ({ name, ...data }));

            // TOP 5 ÏÇ¨Ïù¥Ìä∏
            const topSites = Object.entries(siteStats)
                .sort((a, b) => b[1].sales - a[1].sales)
                .slice(0, 5)
                .map(([name, data]) => ({ name, ...data }));

            // Î∂ÑÏÑù Í≤∞Í≥º ÎîîÎ≤ÑÍ∑∏
            console.log('üìä Î∂ÑÏÑù Í≤∞Í≥º (depth=' + targetDepth + '):', {
                Ïπ¥ÌÖåÍ≥†Î¶¨Ïàò: Object.keys(stats).length,
                Ï¥ùÌåêÎß§Í∏àÏï°: totalSales,
                Ï¥ùÍ±∞ÎûòÍ±¥Ïàò: totalQty,
                ÌèâÍ∑†Îã®Í∞Ä: totalQty > 0 ? Math.round(totalSales / totalQty) : 0,
                TOP3Ïπ¥ÌÖåÍ≥†Î¶¨: Object.entries(stats).sort((a,b) => b[1].sales - a[1].sales).slice(0,3).map(([k,v]) => `${k}(${formatCurrency(v.sales)})`)
            });

            return {
                stats,
                totalSales,
                totalQty,
                topProducts,
                topSites,
                productCount: Object.keys(products).length,
                avgPrice: totalQty > 0 ? Math.round(totalSales / totalQty) : 0,
                depth: targetDepth
            };
        }

        // ============================================
        // Gemini API
        // ============================================
        async function callGemini(prompt) {
            if (!state.geminiApiKey) {
                showToast('API ÌÇ§Î•º Î®ºÏ†Ä ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî');
                return null;
            }

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${state.geminiApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.8, maxOutputTokens: 2048 }
                })
            });

            const data = await res.json();
            if (data.candidates?.[0]) {
                return data.candidates[0].content.parts[0].text;
            }
            throw new Error(data.error?.message || 'API Ïò§Î•ò');
        }

        // ============================================
        // Î†åÎçîÎßÅ
        // ============================================
        function render() {
            destroyCharts();
            const app = document.getElementById('app');
            app.innerHTML = state.isLoggedIn ? renderApp() : renderLogin();
            attachEvents();

            // Ï∞®Ìä∏ Î†åÎçîÎßÅ
            setTimeout(() => {
                if (state.currentPage === 'dashboard') renderDashboardCharts();
                if (state.currentPage === 'analysis') renderAnalysisCharts();
            }, 100);
        }

        function renderLogin() {
            return `
            <div class="login-container">
                <div class="login-card">
                    <div class="login-logo">
                        <h1>ÎπÑÎìúÎ∞îÏù¥<span>ÏΩîÎ¶¨ÏïÑ</span></h1>
                        <p>ÌåêÎß§ Î∂ÑÏÑù & Îâ¥Ïä§Î†àÌÑ∞ ÏãúÏä§ÌÖú</p>
                    </div>
                    <form id="loginForm">
                        <div class="form-group">
                            <label class="form-label">ÏïÑÏù¥Îîî</label>
                            <input type="text" id="loginId" class="form-input" placeholder="admin" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                            <input type="password" id="loginPw" class="form-input" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•" autocomplete="new-password">
                        </div>
                        <button type="submit" class="btn btn-primary" style="width:100%;margin-top:8px;">Î°úÍ∑∏Ïù∏</button>
                    </form>
                    <p style="text-align:center;margin-top:20px;font-size:13px;color:var(--toss-gray-500);">
                        ÌÖåÏä§Ìä∏ Í≥ÑÏ†ï: admin / admin123
                    </p>
                </div>
            </div>`;
        }

        function renderApp() {
            const menuItems = [
                { id: 'dashboard', icon: 'üìä', label: 'ÎåÄÏãúÎ≥¥Îìú' },
                { id: 'upload', icon: 'üì§', label: 'Îç∞Ïù¥ÌÑ∞ ÏóÖÎ°úÎìú' },
                { id: 'analysis', icon: 'üìà', label: 'ÌåêÎß§ Î∂ÑÏÑù' },
                { id: 'trends', icon: 'üî•', label: 'Ìä∏Î†åÎìú Í¥ÄÎ¶¨' },
                { id: 'newsletter', icon: '‚úâÔ∏è', label: 'Îâ¥Ïä§Î†àÌÑ∞' },
                { id: 'settings', icon: '‚öôÔ∏è', label: 'ÏÑ§Ï†ï' },
            ];

            return `
            <nav class="nav">
                <div class="nav-logo">ÎπÑÎìúÎ∞îÏù¥<span>Ïï†ÎÑêÎ¶¨Ìã±Ïä§</span></div>
                <div class="nav-user">
                    <span style="font-size:14px;color:var(--toss-gray-700);">Í¥ÄÎ¶¨ÏûêÎãò</span>
                    <button class="btn-logout" id="logoutBtn">Î°úÍ∑∏ÏïÑÏõÉ</button>
                </div>
            </nav>
            <aside class="sidebar">
                <ul class="sidebar-menu">
                    ${menuItems.map(m => `
                        <li><button class="sidebar-link ${state.currentPage === m.id ? 'active' : ''}" data-page="${m.id}">
                            <span>${m.icon}</span> ${m.label}
                        </button></li>
                    `).join('')}
                </ul>
            </aside>
            <main class="main">${renderPage()}</main>`;
        }

        function renderPage() {
            switch(state.currentPage) {
                case 'dashboard': return renderDashboard();
                case 'upload': return renderUpload();
                case 'analysis': return renderAnalysis();
                case 'trends': return renderTrends();
                case 'newsletter': return renderNewsletter();
                case 'subscribers': return renderSubscribers();
                case 'settings': return renderSettings();
                default: return renderDashboard();
            }
        }

        // ============================================
        // ÎåÄÏãúÎ≥¥Îìú
        // ============================================
        function renderDashboard() {
            const { stats, totalSales, totalQty, avgPrice } = analyzeCategories();
            const catCount = Object.keys(stats).length;
            const availableMonths = getAvailableMonths();
            const filteredData = getFilteredData();
            const periodLabel = selectedMonth ? `${parseInt(selectedMonth.split('-')[1])}Ïõî` : 'Ï†ÑÏ≤¥';

            return `
            <div class="page-header">
                <h1 class="page-title">ÎåÄÏãúÎ≥¥Îìú</h1>
                <p class="page-desc">${selectedMonth ? `${parseInt(selectedMonth.split('-')[1])}Ïõî` : state.weekInfo.month + 'Ïõî ' + state.weekInfo.week + 'Ï£ºÏ∞®'} ÌòÑÌô©</p>
            </div>

            <!-- ÏõîÎ≥Ñ ÌïÑÌÑ∞ -->
            ${state.salesData.length > 0 && availableMonths.length > 0 ? `
            <div class="card" style="margin-bottom:20px;padding:16px;">
                <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                    <span style="font-weight:600;color:var(--toss-gray-700);">üìÖ Í∏∞Í∞Ñ ÏÑ†ÌÉù:</span>
                    <button class="btn ${!selectedMonth ? 'btn-primary' : 'btn-secondary'} btn-sm month-selector" data-month="">
                        Ï†ÑÏ≤¥ (${formatNumber(state.salesData.length)}Í±¥)
                    </button>
                    ${availableMonths.map(m => {
                        const monthData = state.salesData.filter(item => {
                            const dateCol = columnMapping.date;
                            let dateVal = dateCol ? item[dateCol] : item['Í≤∞Ï†úÏùº'];
                            if (!dateVal) return false;
                            let date;
                            if (dateVal instanceof Date) date = dateVal;
                            else if (typeof dateVal === 'number') date = new Date((dateVal - 25569) * 86400 * 1000);
                            else if (typeof dateVal === 'string') date = new Date(dateVal);
                            if (date && !isNaN(date.getTime())) {
                                const monthKey = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
                                return monthKey === m;
                            }
                            return false;
                        });
                        return '<button class="btn ' + (selectedMonth === m ? 'btn-primary' : 'btn-secondary') + ' btn-sm month-selector" data-month="' + m + '">' +
                            parseInt(m.split('-')[1]) + 'Ïõî (' + formatNumber(monthData.length) + 'Í±¥)</button>';
                    }).join('')}
                    <button class="btn btn-danger btn-sm" id="resetDataBtn" style="margin-left:auto;">üóëÔ∏è Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî</button>
                </div>
            </div>
            ` : ''}

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Ï¥ù ÌåêÎß§Í∏àÏï° (${periodLabel})</div>
                    <div class="stat-value blue">${formatCurrency(totalSales)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ï¥ù Í±∞ÎûòÍ±¥Ïàò (${periodLabel})</div>
                    <div class="stat-value">${formatNumber(totalQty)}Í±¥</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ÌèâÍ∑† Îã®Í∞Ä</div>
                    <div class="stat-value">${formatCurrency(avgPrice)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ïπ¥ÌÖåÍ≥†Î¶¨</div>
                    <div class="stat-value">${catCount}Í∞ú</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header"><h3 class="card-title">Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÌåêÎß§</h3></div>
                    <div class="chart-container" style="height:280px;"><canvas id="catChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üî• TOP 5 Ïù∏Í∏∞ ÌÇ§ÏõåÎìú</h3>
                        <a href="#" class="trend-link" data-page="trends" style="font-size:13px;color:var(--toss-blue);">ÎçîÎ≥¥Í∏∞ ‚Üí</a>
                    </div>
                    ${state.trendData.length > 0 ? `
                    <div>
                        ${state.trendData.slice(0, 5).map((t, i) => `
                        <div class="data-row" style="padding:12px 0;border-bottom:1px solid var(--toss-gray-100);">
                            <div style="display:flex;align-items:center;gap:10px;">
                                <span class="badge ${i < 3 ? 'badge-red' : 'badge-blue'}" style="min-width:24px;text-align:center;">${i + 1}</span>
                                <div>
                                    <strong style="font-size:14px;">${t.keyword}</strong>
                                    <div style="font-size:12px;color:var(--toss-gray-500);margin-top:2px;">üìÇ ${t.category}</div>
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-weight:600;color:var(--toss-blue);">${formatNumber(t.searches)}Í±¥</div>
                                <div style="font-size:12px;color:var(--toss-gray-500);">${formatCurrency(t.price)}</div>
                            </div>
                        </div>
                        `).join('')}
                    </div>
                    ` : '<div class="empty-state"><div class="empty-icon">üìä</div><div class="empty-title">Ìä∏Î†åÎìú Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</div><div class="empty-desc">Îç∞Ïù¥ÌÑ∞ ÏóÖÎ°úÎìú ÌõÑ ÏûêÎèô Ï∂îÏ∂úÎê©ÎãàÎã§</div></div>'}
                </div>
            </div>`;
        }

        function renderDashboardCharts() {
            const { stats } = analyzeCategories();
            const ctx = document.getElementById('catChart');

            if (ctx && Object.keys(stats).length > 0) {
                // ÌåêÎß§Í∏àÏï° Í∏∞Ï§Ä Ï†ïÎ†¨ ÌõÑ TOP 6 + Í∏∞ÌÉÄ
                const sorted = Object.entries(stats).sort((a, b) => b[1].sales - a[1].sales);
                const top6 = sorted.slice(0, 6);
                const others = sorted.slice(6);
                const otherSales = others.reduce((sum, [, data]) => sum + data.sales, 0);

                const labels = top6.map(([cat]) => cat.length > 10 ? cat.substring(0, 10) + '...' : cat);
                const data = top6.map(([, d]) => d.sales);

                if (otherSales > 0) {
                    labels.push('Í∏∞ÌÉÄ');
                    data.push(otherSales);
                }

                // ÌÜ†Ïä§ Ïä§ÌÉÄÏùº Î∏îÎ£® Í≥ÑÏó¥ Í∑∏ÎùºÎç∞Ïù¥ÏÖò ÏÉâÏÉÅ
                const colors = [
                    '#3182F6', // ÌÜ†Ïä§ Î∏îÎ£®
                    '#4A9CFF', // Î∞ùÏùÄ Î∏îÎ£®
                    '#6BB3FF', // Îçî Î∞ùÏùÄ Î∏îÎ£®
                    '#8ECAFF', // Ïó∞Ìïú Î∏îÎ£®
                    '#B0DAFF', // ÏïÑÏ£º Ïó∞Ìïú Î∏îÎ£®
                    '#D0EAFF', // Îß§Ïö∞ Ïó∞Ìïú Î∏îÎ£®
                    '#E8E8E8'  // Í∏∞ÌÉÄ (ÌöåÏÉâ)
                ];

                state.charts.cat = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '55%',
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 12,
                                    padding: 8,
                                    font: { size: 11 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${context.label}: ¬•${value.toLocaleString()} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // ============================================
        // Îç∞Ïù¥ÌÑ∞ ÏóÖÎ°úÎìú
        // ============================================
        function renderUpload() {
            return `
            <div class="page-header">
                <h1 class="page-title">Îç∞Ïù¥ÌÑ∞ ÏóÖÎ°úÎìú</h1>
                <p class="page-desc">ÏóëÏÖÄ ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÏó¨ ÌåêÎß§ Îç∞Ïù¥ÌÑ∞Î•º Î∂ÑÏÑùÌïòÏÑ∏Ïöî</p>
            </div>

            <div class="card">
                <div class="upload-zone" id="uploadZone">
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none;">
                    <div class="upload-icon">üìÅ</div>
                    <div class="upload-title">ÏóëÏÖÄ ÌååÏùºÏùÑ ÎìúÎûòÍ∑∏ÌïòÍ±∞ÎÇò ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî</div>
                    <div class="upload-desc">ÏßÄÏõê ÌòïÏãù: .xlsx, .xls, .csv (ÏµúÎåÄ 50MB)</div>
                </div>
                <div id="uploadStatus" style="margin-top:16px;display:none;">
                    <div style="display:flex;align-items:center;gap:12px;padding:16px;background:var(--toss-blue-light);border-radius:12px;">
                        <div class="spinner" style="width:24px;height:24px;border:3px solid var(--toss-blue);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;"></div>
                        <span id="uploadStatusText" style="color:var(--toss-blue);font-weight:600;">ÏóÖÎ°úÎìú Ï§ë...</span>
                    </div>
                </div>
                <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
            </div>

            ${state.salesData.length > 0 ? `
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üìã Ïª¨Îüº Îß§Ìïë ÏÑ§Ï†ï</h3>
                    <button class="btn btn-secondary btn-sm" id="autoDetectBtn">üîç ÏûêÎèô Í∞êÏßÄ</button>
                </div>
                <p style="color:var(--toss-gray-600);margin-bottom:16px;">ÏóëÏÖÄ ÌååÏùºÏùò Ïª¨ÎüºÏùÑ Î∂ÑÏÑùÏóê ÏÇ¨Ïö©Ìï† Ìï≠Î™©Í≥º Ïó∞Í≤∞Ìï¥Ï£ºÏÑ∏Ïöî:</p>

                <!-- Í≥ÑÏ∏µÏ†Å Ïπ¥ÌÖåÍ≥†Î¶¨ Îß§Ìïë -->
                <div style="margin-bottom:16px;">
                    <label class="form-label" style="font-weight:600;">üìÇ Ïπ¥ÌÖåÍ≥†Î¶¨ Í≥ÑÏ∏µ ÏÑ§Ï†ï</label>
                    <div class="grid-2" style="gap:12px;">
                        ${['category1', 'category2', 'category3', 'category4'].map((type, idx) => {
                            const labels = { category1: 'ÎåÄÎ∂ÑÎ•ò (Depth 1)', category2: 'Ï§ëÎ∂ÑÎ•ò (Depth 2)', category3: 'ÏÜåÎ∂ÑÎ•ò (Depth 3)', category4: 'ÏÑ∏Î∂ÄÎ∂ÑÎ•ò (Depth 4)' };
                            const columns = Object.keys(state.salesData[0]);
                            return `
                            <div class="form-group" style="margin-bottom:0;">
                                <label class="form-label" style="font-size:12px;color:var(--toss-gray-500);">${labels[type]}</label>
                                <select class="form-input form-select column-select" data-type="${type}">
                                    <option value="">-- ÏÑ†ÌÉù ÏïàÌï® --</option>
                                    ${columns.map(col => `<option value="${col}" ${columnMapping[type] === col ? 'selected' : ''}>${col}</option>`).join('')}
                                </select>
                            </div>`;
                        }).join('')}
                    </div>
                </div>

                <!-- Í∏∞ÌÉÄ Ïª¨Îüº Îß§Ìïë -->
                <div class="grid-2" style="gap:12px;">
                    ${['sales', 'product', 'date', 'site'].map(type => {
                        const labels = { sales: 'üí∞ ÌåêÎß§Í∏àÏï°/ÏÉÅÌíàÍ∞Ä', product: 'üè∑Ô∏è ÏÉÅÌíàÎ™Ö', date: 'üìÖ ÎÇ†Ïßú', site: 'üåê ÏÇ¨Ïù¥Ìä∏' };
                        const columns = Object.keys(state.salesData[0]);
                        return `
                        <div class="form-group" style="margin-bottom:0;">
                            <label class="form-label">${labels[type]}</label>
                            <select class="form-input form-select column-select" data-type="${type}">
                                <option value="">-- ÏÑ†ÌÉù ÏïàÌï® --</option>
                                ${columns.map(col => `<option value="${col}" ${columnMapping[type] === col ? 'selected' : ''}>${col}</option>`).join('')}
                            </select>
                        </div>`;
                    }).join('')}
                </div>
                <button class="btn btn-primary" style="width:100%;margin-top:16px;" id="saveColumnMappingBtn">üíæ Îß§Ìïë Ï†ÄÏû• ÌõÑ Î∂ÑÏÑùÌïòÍ∏∞</button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ÏóÖÎ°úÎìúÎêú Îç∞Ïù¥ÌÑ∞ (${formatNumber(state.salesData.length)}Í±¥)</h3>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-primary" id="analyzeBtn">üìà Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑùÌïòÍ∏∞</button>
                        <button class="btn btn-danger btn-sm" id="clearDataBtn">ÏÇ≠Ï†ú</button>
                    </div>
                </div>
                <div class="info-box green">
                    ‚úÖ ${formatNumber(state.salesData.length)}Í±¥Ïùò Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§.
                    ${columnMapping.category1 ? `<br>üìÇ Ïπ¥ÌÖåÍ≥†Î¶¨1: <strong>${columnMapping.category1}</strong>` : ''}
                    ${columnMapping.category2 ? ` ‚Üí ${columnMapping.category2}` : ''}
                    ${columnMapping.category3 ? ` ‚Üí ${columnMapping.category3}` : ''}
                    ${columnMapping.category4 ? ` ‚Üí ${columnMapping.category4}` : ''}
                    ${columnMapping.sales ? `<br>üí∞ Í∏àÏï°: <strong>${columnMapping.sales}</strong>` : ''}
                    ${columnMapping.site ? ` | üåê ÏÇ¨Ïù¥Ìä∏: <strong>${columnMapping.site}</strong>` : ''}
                </div>
                <div class="table-wrapper" style="max-height:400px;overflow-y:auto;margin-top:16px;">
                    <table class="table">
                        <thead>
                            <tr>${Object.keys(state.salesData[0]).slice(0, 6).map(k => `<th>${k}</th>`).join('')}</tr>
                        </thead>
                        <tbody>
                            ${state.salesData.slice(0, 20).map(row => `
                            <tr>${Object.values(row).slice(0, 6).map(v => `<td>${v}</td>`).join('')}</tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                ${state.salesData.length > 20 ? `<p style="text-align:center;color:var(--toss-gray-500);padding:16px;">... Ïô∏ ${formatNumber(state.salesData.length - 20)}Í±¥</p>` : ''}
            </div>
            ` : `
            <div class="card">
                <div class="card-header"><h3 class="card-title">Îç∞Ïù¥ÌÑ∞ ÌòïÏãù ÏïàÎÇ¥</h3></div>
                <p style="color:var(--toss-gray-600);margin-bottom:16px;">ÏóëÏÖÄ ÌååÏùºÏóê Îã§Ïùå Ïó¥Ïù¥ Ìè¨Ìï®ÎêòÏñ¥Ïïº Ìï©ÎãàÎã§:</p>
                <table class="table">
                    <thead><tr><th>Ïó¥ Ïù¥Î¶Ñ</th><th>ÏÑ§Î™Ö</th><th>ÌïÑÏàò</th></tr></thead>
                    <tbody>
                        <tr><td><code>Ïπ¥ÌÖåÍ≥†Î¶¨</code></td><td>ÏÉÅÌíà Ïπ¥ÌÖåÍ≥†Î¶¨</td><td><span class="badge badge-red">ÌïÑÏàò</span></td></tr>
                        <tr><td><code>ÌåêÎß§Í∏àÏï°</code></td><td>ÌåêÎß§ Í∏àÏï°</td><td><span class="badge badge-red">ÌïÑÏàò</span></td></tr>
                        <tr><td><code>ÌåêÎß§ÏàòÎüâ</code></td><td>ÌåêÎß§ ÏàòÎüâ</td><td><span class="badge badge-blue">ÏÑ†ÌÉù</span></td></tr>
                    </tbody>
                </table>
            </div>
            `}`;
        }

        // ============================================
        // ÌåêÎß§ Î∂ÑÏÑù
        // ============================================
        function renderAnalysis() {
            if (state.salesData.length === 0) {
                return `
                <div class="page-header">
                    <h1 class="page-title">ÌåêÎß§ Î∂ÑÏÑù</h1>
                    <p class="page-desc">Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÌåêÎß§ ÌòÑÌô©ÏùÑ Î∂ÑÏÑùÌï©ÎãàÎã§</p>
                </div>
                <div class="card">
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <div class="empty-title">Î∂ÑÏÑùÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</div>
                        <div class="empty-desc">Îç∞Ïù¥ÌÑ∞ ÏóÖÎ°úÎìú ÌéòÏù¥ÏßÄÏóêÏÑú ÏóëÏÖÄ ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî</div>
                        <button class="btn btn-primary" style="margin-top:20px;" data-page="upload">Îç∞Ïù¥ÌÑ∞ ÏóÖÎ°úÎìúÌïòÍ∏∞</button>
                    </div>
                </div>`;
            }

            // ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïõî Î™©Î°ù
            const availableMonths = getAvailableMonths();
            const filteredData = getFilteredData();

            const analysis = analyzeCategories();
            const { stats, totalSales, totalQty, avgPrice } = analysis;
            const sortedCats = Object.entries(stats).sort((a, b) => b[1].sales - a[1].sales);
            const maxSales = sortedCats[0]?.[1]?.sales || 1;
            const maxQty = Math.max(...sortedCats.map(([_, d]) => d.count)) || 1;

            // Îß§ÌïëÎêú Ïπ¥ÌÖåÍ≥†Î¶¨ depth ÌôïÏù∏
            const availableDepths = [];
            if (columnMapping.category1) availableDepths.push({ depth: 1, label: 'ÎåÄÎ∂ÑÎ•ò', col: columnMapping.category1 });
            if (columnMapping.category2) availableDepths.push({ depth: 2, label: 'Ï§ëÎ∂ÑÎ•ò', col: columnMapping.category2 });
            if (columnMapping.category3) availableDepths.push({ depth: 3, label: 'ÏÜåÎ∂ÑÎ•ò', col: columnMapping.category3 });
            if (columnMapping.category4) availableDepths.push({ depth: 4, label: 'ÏÑ∏Î∂ÄÎ∂ÑÎ•ò', col: columnMapping.category4 });

            // Ïõî ÌëúÏãú Ìè¨Îß∑
            const formatMonth = (m) => {
                const [year, month] = m.split('-');
                return `${year}ÎÖÑ ${parseInt(month)}Ïõî`;
            };

            return `
            <div class="page-header">
                <h1 class="page-title">ÌåêÎß§ Î∂ÑÏÑù</h1>
                <p class="page-desc">Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÌåêÎß§ ÌòÑÌô© (ÏóîÌôî Í∏∞Ï§Ä) - ${selectedMonth ? formatMonth(selectedMonth) : 'Ï†ÑÏ≤¥ Í∏∞Í∞Ñ'} ${formatNumber(filteredData.length)}Í±¥</p>
            </div>

            <!-- ÏõîÎ≥Ñ ÌïÑÌÑ∞ -->
            ${availableMonths.length > 0 ? `
            <div class="card" style="margin-bottom:20px;">
                <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                    <span style="font-weight:600;color:var(--toss-gray-700);">üìÖ Í∏∞Í∞Ñ ÏÑ†ÌÉù:</span>
                    <button class="btn ${!selectedMonth ? 'btn-primary' : 'btn-secondary'} btn-sm month-selector" data-month="">
                        Ï†ÑÏ≤¥ (${formatNumber(state.salesData.length)}Í±¥)
                    </button>
                    ${availableMonths.map(m => {
                        const monthData = state.salesData.filter(item => {
                            let dateVal = columnMapping.date ? item[columnMapping.date] : item['Í≤∞Ï†úÏùº'];
                            if (!dateVal) return false;
                            let date = dateVal instanceof Date ? dateVal : new Date(dateVal);
                            if (isNaN(date.getTime())) return false;
                            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}` === m;
                        });
                        return `
                        <button class="btn ${selectedMonth === m ? 'btn-primary' : 'btn-secondary'} btn-sm month-selector" data-month="${m}">
                            ${parseInt(m.split('-')[1])}Ïõî (${formatNumber(monthData.length)}Í±¥)
                        </button>`;
                    }).join('')}
                </div>
            </div>
            ` : ''}

            <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ Depth ÏÑ†ÌÉù -->
            ${availableDepths.length > 1 ? `
            <div class="card" style="margin-bottom:20px;">
                <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
                    <span style="font-weight:600;color:var(--toss-gray-700);">üìÇ Î∂ÑÏÑù Í∏∞Ï§Ä:</span>
                    ${availableDepths.map(d => `
                        <button class="btn ${analysisCategoryDepth === d.depth ? 'btn-primary' : 'btn-secondary'} btn-sm depth-selector" data-depth="${d.depth}">
                            ${d.label}
                        </button>
                    `).join('')}
                </div>
            </div>
            ` : ''}

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Ï¥ù ÌåêÎß§Í∏àÏï°</div>
                    <div class="stat-value blue">${formatCurrency(totalSales)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ï¥ù Í±∞ÎûòÍ±¥Ïàò</div>
                    <div class="stat-value">${formatNumber(totalQty)}Í±¥</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ÌèâÍ∑† Í±∞ÎûòÍ∏àÏï°</div>
                    <div class="stat-value">${formatCurrency(totalQty > 0 ? Math.round(totalSales / totalQty) : 0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ïπ¥ÌÖåÍ≥†Î¶¨ Ïàò</div>
                    <div class="stat-value">${sortedCats.length}Í∞ú</div>
                </div>
            </div>

            <!-- Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Ï¥ù ÌåêÎß§Í∏àÏï° (Í∞ÄÎ°ú ÎßâÎåÄ) -->
            <div class="card">
                <div class="card-header"><h3 class="card-title">üìä Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Ï¥ù ÌåêÎß§Í∏àÏï°</h3></div>
                ${sortedCats.slice(0, 10).map(([cat, data], i) => `
                <div style="margin-bottom:16px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span class="badge ${i < 3 ? 'badge-red' : 'badge-blue'}" style="min-width:24px;text-align:center;">${i + 1}</span>
                            <strong style="font-size:14px;">${cat}</strong>
                        </div>
                        <span style="font-size:14px;font-weight:600;color:var(--toss-blue);">${formatCurrency(data.sales)}</span>
                    </div>
                    <div style="background:var(--toss-gray-100);border-radius:6px;height:24px;overflow:hidden;">
                        <div style="background:linear-gradient(90deg, #3182F6, #60A5FA);height:100%;width:${Math.round(data.sales/maxSales*100)}%;border-radius:6px;display:flex;align-items:center;justify-content:flex-end;padding-right:8px;">
                            <span style="color:white;font-size:11px;font-weight:600;">${data.ratio}%</span>
                        </div>
                    </div>
                </div>
                `).join('')}
                ${sortedCats.length > 10 ? `<p style="text-align:center;color:var(--toss-gray-500);padding:8px;">... Ïô∏ ${sortedCats.length - 10}Í∞ú Ïπ¥ÌÖåÍ≥†Î¶¨</p>` : ''}
            </div>

            <!-- Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Í±∞ÎûòÍ±¥Ïàò (Í∞ÄÎ°ú ÎßâÎåÄ) -->
            <div class="card">
                <div class="card-header"><h3 class="card-title">üì¶ Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Í±∞ÎûòÍ±¥Ïàò</h3></div>
                ${sortedCats.slice(0, 10).map(([cat, data], i) => `
                <div style="margin-bottom:16px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span class="badge ${i < 3 ? 'badge-red' : 'badge-blue'}" style="min-width:24px;text-align:center;">${i + 1}</span>
                            <strong style="font-size:14px;">${cat}</strong>
                        </div>
                        <span style="font-size:14px;font-weight:600;color:var(--toss-green);">${formatNumber(data.count)}Í±¥</span>
                    </div>
                    <div style="background:var(--toss-gray-100);border-radius:6px;height:24px;overflow:hidden;">
                        <div style="background:linear-gradient(90deg, #30B06E, #4ADE80);height:100%;width:${Math.round(data.count/Math.max(...sortedCats.map(([_,d])=>d.count))*100)}%;border-radius:6px;"></div>
                    </div>
                </div>
                `).join('')}
            </div>

            <!-- ÌåêÎß§Í∏àÏï° ÎπÑÏú® ÌååÏù¥ Ï∞®Ìä∏ -->
            <div class="card">
                <div class="card-header"><h3 class="card-title">ü•ß ÌåêÎß§Í∏àÏï° ÎπÑÏú®</h3></div>
                <div class="chart-container" style="height:350px;"><canvas id="salesPieChart"></canvas></div>
            </div>

            <!-- Í±∞ÎûòÍ±¥Ïàò Î∞î Ï∞®Ìä∏ (Ï†ÑÏ≤¥ ÎÑàÎπÑ) -->
            <div class="card">
                <div class="card-header"><h3 class="card-title">üìà Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Í±∞ÎûòÍ±¥Ïàò</h3></div>
                <div class="chart-container" style="height:400px;"><canvas id="qtyBarChart"></canvas></div>
            </div>

            <!-- Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏÉÅÏÑ∏ ÌÖåÏù¥Î∏î -->
            <div class="card">
                <div class="card-header"><h3 class="card-title">üìã Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏÉÅÏÑ∏</h3></div>
                <div style="overflow-x:auto;">
                    <table class="table">
                        <thead><tr><th>ÏàúÏúÑ</th><th>Ïπ¥ÌÖåÍ≥†Î¶¨</th><th>Ï¥ù ÌåêÎß§Í∏àÏï°</th><th>ÌèâÍ∑† Í∏àÏï°</th><th>ÎπÑÏ§ë</th><th>Í±∞ÎûòÍ±¥Ïàò</th></tr></thead>
                        <tbody>
                            ${sortedCats.map(([cat, data], i) => `
                            <tr>
                                <td><span class="badge ${i < 3 ? 'badge-red' : 'badge-blue'}">${i + 1}</span></td>
                                <td><strong>${cat}</strong></td>
                                <td style="text-align:right;font-weight:600;color:var(--toss-blue);">${formatCurrency(data.sales)}</td>
                                <td style="text-align:right;">${formatCurrency(data.count > 0 ? Math.round(data.sales / data.count) : 0)}</td>
                                <td>
                                    <div style="display:flex;align-items:center;gap:8px;">
                                        <div class="progress-bar" style="flex:1;height:8px;"><div class="progress-fill" style="width:${parseFloat(data.ratio)}%;"></div></div>
                                        <span style="min-width:50px;text-align:right;">${data.ratio}%</span>
                                    </div>
                                </td>
                                <td style="text-align:right;">${formatNumber(data.count)}Í±¥</td>
                            </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
        }

        function renderAnalysisCharts() {
            const { stats, totalSales } = analyzeCategories();
            const allCats = Object.keys(stats);

            // Ï∞®Ìä∏ ÏÉâÏÉÅ ÌåîÎ†àÌä∏ (10Í∞ú - ÍπîÎÅîÌïòÍ≤å)
            const chartColors = [
                '#3182F6', '#F04452', '#30B06E', '#F59F00', '#8B5CF6',
                '#EC4899', '#06B6D4', '#F97316', '#6366F1', '#8B95A1'
            ];

            // TOP 8 + Í∏∞ÌÉÄÎ°ú Ï†ïÎ¶¨
            const sortedCats = allCats.sort((a, b) => stats[b].sales - stats[a].sales);
            const top8 = sortedCats.slice(0, 8);
            const otherCats = sortedCats.slice(8);
            const otherTotal = otherCats.reduce((sum, c) => sum + stats[c].sales, 0);

            const pieLabels = otherCats.length > 0 ? [...top8, `Í∏∞ÌÉÄ (${otherCats.length}Í∞ú)`] : top8;
            const pieData = otherCats.length > 0
                ? [...top8.map(c => stats[c].sales), otherTotal]
                : top8.map(c => stats[c].sales);

            const pieCtx = document.getElementById('salesPieChart');
            if (pieCtx && pieLabels.length > 0) {
                state.charts.pie = new Chart(pieCtx, {
                    type: 'doughnut',
                    data: {
                        labels: pieLabels,
                        datasets: [{
                            data: pieData,
                            backgroundColor: pieLabels.map((_, i) => chartColors[i % chartColors.length]),
                            borderWidth: 3,
                            borderColor: '#fff',
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '40%',
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    padding: 12,
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                    font: { size: 13, weight: '500' },
                                    generateLabels: function(chart) {
                                        const data = chart.data;
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percent = totalSales > 0 ? ((value / totalSales) * 100).toFixed(1) : 0;
                                            const shortLabel = label.length > 10 ? label.substring(0, 10) + '..' : label;
                                            return {
                                                text: `${shortLabel}  ${percent}%`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                padding: 12,
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        const percent = totalSales > 0 ? ((value / totalSales) * 100).toFixed(1) : 0;
                                        return ` ${formatCurrency(value)} (${percent}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // Î∞î Ï∞®Ìä∏: TOP 10Îßå ÌëúÏãú
            const barCtx = document.getElementById('qtyBarChart');
            const top10Cats = sortedCats.slice(0, 10);

            if (barCtx && top10Cats.length > 0) {
                state.charts.bar = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: top10Cats.map(c => c.length > 15 ? c.substring(0, 15) + '...' : c),
                        datasets: [{
                            label: 'Í±∞ÎûòÍ±¥Ïàò',
                            data: top10Cats.map(c => stats[c].count),
                            backgroundColor: top10Cats.map((_, i) => chartColors[i % chartColors.length]),
                            borderRadius: 6,
                            barThickness: 35
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                padding: 12,
                                callbacks: {
                                    title: function(context) {
                                        return top10Cats[context[0].dataIndex];
                                    },
                                    label: function(context) {
                                        const cat = top10Cats[context.dataIndex];
                                        return [
                                            `Í±∞ÎûòÍ±¥Ïàò: ${formatNumber(context.raw)}Í±¥`,
                                            `ÌåêÎß§Í∏àÏï°: ${formatCurrency(stats[cat].sales)}`
                                        ];
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0,0,0,0.05)' },
                                ticks: {
                                    font: { size: 12 },
                                    callback: function(value) {
                                        return formatNumber(value) + 'Í±¥';
                                    }
                                }
                            },
                            y: {
                                grid: { display: false },
                                ticks: {
                                    font: { size: 13, weight: '500' },
                                    padding: 8
                                }
                            }
                        }
                    }
                });
            }
        }

        // ============================================
        // Ìä∏Î†åÎìú Í¥ÄÎ¶¨
        // ============================================
        function renderTrends() {
            const hasData = state.salesData && state.salesData.length > 0;
            const filteredData = getFilteredData();
            const totalSearches = state.trendData.reduce((sum, t) => sum + t.searches, 0);
            const totalSales = state.trendData.reduce((sum, t) => sum + (t.price * t.searches), 0);
            const availableMonths = getAvailableMonths();
            const periodLabel = selectedMonth ? `${parseInt(selectedMonth.split('-')[1])}Ïõî` : 'Ï†ÑÏ≤¥';

            return `
            <div class="page-header">
                <h1 class="page-title">Ìä∏Î†åÎìú Í¥ÄÎ¶¨</h1>
                <p class="page-desc">Ïã§Ï†ú Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò Ïù∏Í∏∞ ÌÇ§ÏõåÎìú TOP 30 ${selectedMonth ? `(${periodLabel})` : ''}</p>
            </div>

            <!-- ÏõîÎ≥Ñ ÌïÑÌÑ∞ -->
            ${hasData && availableMonths.length > 0 ? `
            <div class="card" style="margin-bottom:20px;padding:16px;">
                <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                    <span style="font-weight:600;color:var(--toss-gray-700);">üìÖ Í∏∞Í∞Ñ ÏÑ†ÌÉù:</span>
                    <button class="btn ${!selectedMonth ? 'btn-primary' : 'btn-secondary'} btn-sm month-selector" data-month="">
                        Ï†ÑÏ≤¥ (${formatNumber(state.salesData.length)}Í±¥)
                    </button>
                    ${availableMonths.map(m => {
                        const monthData = state.salesData.filter(item => {
                            const dateCol = columnMapping.date;
                            let dateVal = dateCol ? item[dateCol] : item['Í≤∞Ï†úÏùº'];
                            if (!dateVal) return false;
                            let date;
                            if (dateVal instanceof Date) date = dateVal;
                            else if (typeof dateVal === 'number') date = new Date((dateVal - 25569) * 86400 * 1000);
                            else if (typeof dateVal === 'string') date = new Date(dateVal);
                            if (date && !isNaN(date.getTime())) {
                                const monthKey = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
                                return monthKey === m;
                            }
                            return false;
                        });
                        return '<button class="btn ' + (selectedMonth === m ? 'btn-primary' : 'btn-secondary') + ' btn-sm month-selector" data-month="' + m + '">' +
                            parseInt(m.split('-')[1]) + 'Ïõî (' + formatNumber(monthData.length) + 'Í±¥)</button>';
                    }).join('')}
                </div>
            </div>
            ` : ''}

            <!-- Ìä∏Î†åÎìú ÏöîÏïΩ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Ìä∏Î†åÎìú ÌÇ§ÏõåÎìú (${periodLabel})</div>
                    <div class="stat-value blue">${state.trendData.length}Í∞ú</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ï¥ù Í±∞ÎûòÍ±¥Ïàò</div>
                    <div class="stat-value">${formatNumber(totalSearches)}Í±¥</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Ï∂îÏ†ï Í±∞ÎûòÍ∏àÏï°</div>
                    <div class="stat-value">${formatCurrency(totalSales)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞</div>
                    <div class="stat-value ${hasData ? 'green' : 'red'}">${hasData ? formatNumber(filteredData.length) + 'Í±¥' : 'ÏóÜÏùå'}</div>
                </div>
            </div>

            <!-- Ìä∏Î†åÎìú Ïû¨Ï∂îÏ∂ú -->
            <div class="card" style="margin-bottom:20px;">
                <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
                    <div>
                        <span style="font-weight:600;color:var(--toss-gray-700);">üìä Ìä∏Î†åÎìú ÌÇ§ÏõåÎìú (Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò)</span>
                        <p style="color:var(--toss-gray-500);font-size:13px;margin:4px 0 0 0;">Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ∏Î∂ÄÎ∂ÑÎ•ò(Depth 4) Í∏∞Ï§Ä Í±∞ÎûòÍ±¥Ïàò TOP 30</p>
                    </div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-secondary btn-sm" id="refreshTrendBtn" ${!hasData ? 'disabled' : ''}>
                            üîÑ Ìä∏Î†åÎìú Ïû¨Ï∂îÏ∂ú
                        </button>
                        <button class="btn btn-primary btn-sm" id="addTrendBtn">+ ÏàòÎèô Ï∂îÍ∞Ä</button>
                    </div>
                </div>
            </div>

            ${!hasData ? `
            <div class="info-box yellow" style="margin-bottom:20px;">
                ‚ö†Ô∏è Ìä∏Î†åÎìú Î∂ÑÏÑùÏùÑ ÏúÑÌï¥ Î®ºÏ†Ä <button style="color:var(--toss-blue);background:none;border:none;cursor:pointer;text-decoration:underline;" data-page="upload">Îç∞Ïù¥ÌÑ∞Î•º ÏóÖÎ°úÎìú</button>Ìï¥Ï£ºÏÑ∏Ïöî.
                ÌòÑÏû¨ ÌëúÏãúÎêú Îç∞Ïù¥ÌÑ∞Îäî ÏÉòÌîåÏûÖÎãàÎã§.
            </div>
            ` : ''}

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">üî• TOP ${state.trendData.length} Ïù∏Í∏∞ ÌÇ§ÏõåÎìú</h3>
                    <span class="badge badge-blue">${hasData ? 'Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞' : 'ÏÉòÌîå Îç∞Ïù¥ÌÑ∞'}</span>
                </div>

                ${state.trendData.length > 0 ? `
                <div style="overflow-x:auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th style="width:60px;">ÏàúÏúÑ</th>
                                <th>ÌÇ§ÏõåÎìú (ÏÑ∏Î∂ÄÎ∂ÑÎ•ò)</th>
                                <th>ÏÉÅÏúÑ Ïπ¥ÌÖåÍ≥†Î¶¨</th>
                                <th style="text-align:right;">Í±∞ÎûòÍ±¥Ïàò</th>
                                <th style="text-align:right;">ÌèâÍ∑† Îã®Í∞Ä</th>
                                <th style="text-align:right;">ÎπÑÏ§ë</th>
                                <th style="width:80px;">Í¥ÄÎ¶¨</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${state.trendData.map((t, i) => {
                                const ratio = totalSearches > 0 ? ((t.searches / totalSearches) * 100).toFixed(1) : 0;
                                return `
                                <tr>
                                    <td>
                                        <span class="badge ${i < 3 ? 'badge-red' : i < 10 ? 'badge-blue' : ''}" style="min-width:28px;text-align:center;">
                                            ${i + 1}
                                        </span>
                                    </td>
                                    <td>
                                        <strong style="font-size:14px;">${t.keyword}</strong>
                                        ${t.change > 20 ? '<span style="color:var(--toss-red);margin-left:4px;">üî•</span>' : ''}
                                    </td>
                                    <td style="color:var(--toss-gray-600);">${t.category}</td>
                                    <td style="text-align:right;font-weight:600;color:var(--toss-blue);">${formatNumber(t.searches)}Í±¥</td>
                                    <td style="text-align:right;">${formatCurrency(t.price)}</td>
                                    <td style="text-align:right;">
                                        <div style="display:flex;align-items:center;gap:6px;justify-content:flex-end;">
                                            <div style="width:60px;height:6px;background:var(--toss-gray-100);border-radius:3px;overflow:hidden;">
                                                <div style="height:100%;width:${Math.min(ratio * 3, 100)}%;background:linear-gradient(90deg,#3182F6,#60A5FA);border-radius:3px;"></div>
                                            </div>
                                            <span style="min-width:40px;font-size:12px;">${ratio}%</span>
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn btn-danger btn-sm delete-trend" data-id="${t.id}" style="padding:4px 8px;font-size:11px;">ÏÇ≠Ï†ú</button>
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                ` : '<div class="empty-state"><div class="empty-icon">üî•</div><div class="empty-title">Ìä∏Î†åÎìú Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå</div><div class="empty-desc">Îç∞Ïù¥ÌÑ∞Î•º ÏóÖÎ°úÎìúÌïòÎ©¥ ÏûêÎèôÏúºÎ°ú Ï∂îÏ∂úÎê©ÎãàÎã§</div></div>'}
            </div>`;
        }

        // ============================================
        // Îâ¥Ïä§Î†àÌÑ∞
        // ============================================
        function renderNewsletter() {
            const hasGeminiKey = state.geminiApiKey.length > 10;
            const hasStibeeKey = state.stibeeApiKey.length > 10;
            const today = new Date();
            const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

            return `
            <div class="page-header">
                <h1 class="page-title">Îâ¥Ïä§Î†àÌÑ∞ ÏÉùÏÑ±</h1>
                <p class="page-desc">ÎπÑÎìúÎ∞îÏù¥ Ï£ºÍ∞Ñ Ìä∏Î†åÎìú Îâ¥Ïä§Î†àÌÑ∞Î•º ÏÉùÏÑ±ÌïòÍ≥† Î∞úÏÜ°Ìï©ÎãàÎã§</p>
            </div>

            ${!hasGeminiKey ? `
            <div class="info-box yellow">
                ‚ö†Ô∏è AI ÏΩòÌÖêÏ∏† ÏÉùÏÑ±ÏùÑ ÏúÑÌï¥ <button style="color:var(--toss-blue);background:none;border:none;cursor:pointer;text-decoration:underline;" data-page="settings">ÏÑ§Ï†ï</button>ÏóêÏÑú Gemini API ÌÇ§Î•º Î®ºÏ†Ä Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.
            </div>
            ` : ''}

            <div class="grid-2">
                <!-- Ï¢åÏ∏°: ÏÑ§Ï†ï Ìå®ÎÑê -->
                <div>
                    <div class="card">
                        <div class="card-header"><h3 class="card-title">üìß Îâ¥Ïä§Î†àÌÑ∞ ÏÑ§Ï†ï</h3></div>

                        <div class="form-group">
                            <label class="form-label">Îâ¥Ïä§Î†àÌÑ∞ Ï†úÎ™©</label>
                            <input type="text" id="newsletterTitle" class="form-input"
                                   value="ÎπÑÎìúÎ∞îÏù¥ Ï£ºÍ∞Ñ Ìä∏Î†åÎìú | ${state.weekInfo.month}Ïõî ${state.weekInfo.week}Ï£ºÏ∞®" placeholder="Îâ¥Ïä§Î†àÌÑ∞ Ï†úÎ™©">
                        </div>

                        <div class="form-group">
                            <label class="form-label">ÌëúÏãúÌï† ÌÇ§ÏõåÎìú Ïàò</label>
                            <select id="keywordCount" class="form-input form-select">
                                <option value="10">TOP 10</option>
                                <option value="20">TOP 20</option>
                                <option value="30" selected>TOP 30</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">ÏΩòÌÖêÏ∏† ÏÑπÏÖò ÏÑ†ÌÉù</label>
                            <div style="display:flex;flex-direction:column;gap:8px;">
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                    <input type="checkbox" id="secTrend" checked> üî• Ïù∏Í∏∞ Í≤ÄÏÉâÏñ¥ TOP 10
                                </label>
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                    <input type="checkbox" id="secCategory" checked> üì¶ Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Ïù∏Í∏∞ÎèÑ
                                </label>
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                    <input type="checkbox" id="secAnalysis" checked> üí° Ïù¥Î≤à Ï£º Ìä∏Î†åÎìú Î∂ÑÏÑù (AI)
                                </label>
                                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                                    <input type="checkbox" id="secPromo" checked> üéØ ÌîÑÎ°úÎ™®ÏÖò Î∞∞ÎÑà
                                </label>
                            </div>
                        </div>

                        <div class="info-box blue">
                            üìä ÌòÑÏû¨ ${state.trendData.length}Í∞ú Ìä∏Î†åÎìú ÌÇ§ÏõåÎìú Î≥¥Ïú† Ï§ë
                        </div>

                        <button class="btn btn-primary" style="width:100%;" id="generateNewsletterBtn" ${!hasGeminiKey ? 'disabled' : ''}>
                            ${state.isGenerating ? '‚è≥ ÏÉùÏÑ± Ï§ë...' : '‚ú® Îâ¥Ïä§Î†àÌÑ∞ ÏÉùÏÑ±ÌïòÍ∏∞'}
                        </button>
                    </div>

                    <!-- Î∞úÏÜ° ÏÑ§Ï†ï -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üì§ Ïä§Ìã∞ÎπÑ Î∞úÏÜ° ÏÑ§Ï†ï</h3>
                            <span class="badge ${hasStibeeKey ? 'badge-green' : 'badge-red'}">${hasStibeeKey ? 'Ïó∞Í≤∞Îê®' : 'ÎØ∏Ïó∞Í≤∞'}</span>
                        </div>

                        ${!hasStibeeKey ? `
                        <div class="info-box yellow" style="margin-bottom:16px;">
                            ‚ö†Ô∏è Ïù¥Î©îÏùº Î∞úÏÜ°ÏùÑ ÏúÑÌï¥ ÏÑ§Ï†ïÏóêÏÑú Ïä§Ìã∞ÎπÑ APIÎ•º Ïó∞Í≤∞Ìï¥Ï£ºÏÑ∏Ïöî.
                        </div>
                        ` : `
                        <div class="info-box green" style="margin-bottom:16px;">
                            ‚úÖ Ïä§Ìã∞ÎπÑ API Ïó∞Í≤∞Îê® (Ï£ºÏÜåÎ°ù ID: ${state.stibeeListId || 'ÎØ∏ÏÑ§Ï†ï'})
                        </div>
                        `}

                        <div style="display:flex;gap:8px;">
                            <button class="btn btn-secondary" style="flex:1;" id="previewEmailBtn" ${!state.newsletterHtml ? 'disabled' : ''}>
                                üëÅÔ∏è ÎØ∏Î¶¨Î≥¥Í∏∞
                            </button>
                            <button class="btn btn-primary" style="flex:1;" id="sendStibeeBtn" ${!hasStibeeKey || !state.newsletterHtml ? 'disabled' : ''}>
                                üìß Ïä§Ìã∞ÎπÑÎ°ú Î∞úÏÜ°
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Ïö∞Ï∏°: Îâ¥Ïä§Î†àÌÑ∞ ÎØ∏Î¶¨Î≥¥Í∏∞ -->
                <div class="card" style="padding:0;overflow:hidden;">
                    <div style="background:var(--toss-gray-100);padding:12px 16px;border-bottom:1px solid var(--toss-gray-200);display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-weight:600;font-size:14px;">üìß Îâ¥Ïä§Î†àÌÑ∞ ÎØ∏Î¶¨Î≥¥Í∏∞</span>
                        <div style="display:flex;gap:8px;">
                            <button class="btn btn-secondary btn-sm" id="copyHtmlBtn" ${!state.newsletterHtml ? 'disabled' : ''}>HTML Î≥µÏÇ¨</button>
                            <button class="btn btn-secondary btn-sm" id="downloadHtmlBtn" ${!state.newsletterHtml ? 'disabled' : ''}>Îã§Ïö¥Î°úÎìú</button>
                        </div>
                    </div>
                    <div id="newsletterPreview" style="background:#f5f5f5;min-height:600px;max-height:800px;overflow-y:auto;">
                        ${state.newsletterHtml || generateDefaultPreview()}
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><h3 class="card-title">üìã Î∞úÏÜ° ÎÇ¥Ïó≠</h3></div>
                ${state.newsletters.length > 0 ? `
                <table class="table">
                    <thead><tr><th>Ï†úÎ™©</th><th>Î∞úÏÜ°Ïùº</th><th>ÏàòÏã†Ïûê</th><th>ÏÉÅÌÉú</th><th>Í¥ÄÎ¶¨</th></tr></thead>
                    <tbody>
                        ${state.newsletters.map(n => `
                        <tr>
                            <td><strong>${n.title}</strong></td>
                            <td>${n.sentAt}</td>
                            <td>${n.recipients}Î™Ö</td>
                            <td><span class="badge badge-green">Î∞úÏÜ°ÏôÑÎ£å</span></td>
                            <td><button class="btn btn-secondary btn-sm view-newsletter" data-id="${n.id}">Î≥¥Í∏∞</button></td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>
                ` : '<div class="empty-state"><div class="empty-icon">‚úâÔ∏è</div><div class="empty-title">Î∞úÏÜ° ÎÇ¥Ïó≠ ÏóÜÏùå</div><div class="empty-desc">Îâ¥Ïä§Î†àÌÑ∞Î•º ÏÉùÏÑ±ÌïòÍ≥† Î∞úÏÜ°Ìï¥Î≥¥ÏÑ∏Ïöî</div></div>'}
            </div>`;
        }

        // Í∏∞Î≥∏ ÎØ∏Î¶¨Î≥¥Í∏∞ ÌÖúÌîåÎ¶ø
        function generateDefaultPreview() {
            return `
            <div style="max-width:600px;margin:0 auto;background:white;font-family:-apple-system,BlinkMacSystemFont,'Pretendard',sans-serif;">
                <div style="background:linear-gradient(135deg,#F04452 0%,#FF6B6B 100%);padding:32px;text-align:center;">
                    <div style="font-size:24px;font-weight:700;color:white;margin-bottom:8px;">üõí ÎπÑÎìúÎ∞îÏù¥ Ï£ºÍ∞Ñ Ìä∏Î†åÎìú</div>
                    <div style="font-size:14px;color:rgba(255,255,255,0.9);">${new Date().toLocaleDateString('ko-KR')} Í∏∞Ï§Ä | 20ÎÖÑ Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò Î∂ÑÏÑù</div>
                </div>
                <div style="padding:32px;text-align:center;color:#666;">
                    <div style="font-size:48px;margin-bottom:16px;">üìß</div>
                    <div style="font-size:18px;font-weight:600;color:#333;margin-bottom:8px;">Îâ¥Ïä§Î†àÌÑ∞ ÎØ∏Î¶¨Î≥¥Í∏∞</div>
                    <div style="font-size:14px;">ÏôºÏ™ΩÏóêÏÑú ÏÑ§Ï†ï ÌõÑ "Îâ¥Ïä§Î†àÌÑ∞ ÏÉùÏÑ±ÌïòÍ∏∞" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî</div>
                </div>
            </div>`;
        }

        // Îâ¥Ïä§Î†àÌÑ∞ HTML ÏÉùÏÑ±
        function generateNewsletterHtml(aiAnalysis = '') {
            const today = new Date();
            const dateStr = today.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
            const keywordCount = parseInt(document.getElementById('keywordCount')?.value || 10);
            const topKeywords = [...state.trendData].sort((a,b) => b.searches - a.searches).slice(0, keywordCount);
            const top10 = topKeywords.slice(0, 10);

            // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏßëÍ≥Ñ
            const categoryStats = {};
            state.trendData.forEach(t => {
                if (!categoryStats[t.category]) categoryStats[t.category] = 0;
                categoryStats[t.category] += t.searches;
            });
            const sortedCategories = Object.entries(categoryStats).sort((a,b) => b[1] - a[1]).slice(0, 5);
            const maxCatValue = sortedCategories[0]?.[1] || 1;

            // Í∏âÏÉÅÏäπ ÌÇ§ÏõåÎìú (change > 20%)
            const hotKeywords = topKeywords.filter(t => t.change > 20).slice(0, 3);

            const secTrend = document.getElementById('secTrend')?.checked !== false;
            const secCategory = document.getElementById('secCategory')?.checked !== false;
            const secAnalysis = document.getElementById('secAnalysis')?.checked !== false;
            const secPromo = document.getElementById('secPromo')?.checked !== false;

            return `
<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"></head>
<body style="margin:0;padding:0;background:#f5f5f5;font-family:-apple-system,BlinkMacSystemFont,'Pretendard','Malgun Gothic',sans-serif;">
<div style="max-width:600px;margin:0 auto;background:white;">
    <!-- Ìó§Îçî -->
    <div style="background:linear-gradient(135deg,#F04452 0%,#FF6B6B 100%);padding:32px 24px;text-align:center;">
        <div style="font-size:12px;color:rgba(255,255,255,0.8);margin-bottom:8px;">üõí ÎπÑÎìúÎ∞îÏù¥ Ï£ºÍ∞Ñ Ìä∏Î†åÎìú</div>
        <div style="font-size:14px;color:rgba(255,255,255,0.9);margin-bottom:16px;">${dateStr} Í∏∞Ï§Ä | 20ÎÖÑ Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò Î∂ÑÏÑù</div>
        <div style="background:rgba(255,255,255,0.2);border-radius:12px;padding:16px;margin-top:8px;">
            <div style="font-size:12px;color:rgba(255,255,255,0.9);margin-bottom:4px;">üî• Ïù¥Î≤à Ï£º Í≤ÄÏÉâ 1ÏúÑ</div>
            <div style="font-size:28px;font-weight:700;color:white;">${top10[0]?.keyword || 'Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå'}</div>
            <div style="font-size:14px;color:rgba(255,255,255,0.9);margin-top:4px;">${formatNumber(top10[0]?.searches || 0)}Í±¥ Í≤ÄÏÉâ</div>
        </div>
    </div>

    ${secTrend ? `
    <!-- Ïù∏Í∏∞ Í≤ÄÏÉâÏñ¥ TOP 10 -->
    <div style="padding:24px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
            <span style="font-size:18px;">‚òëÔ∏è</span>
            <span style="font-size:18px;font-weight:700;color:#333;">Ïù∏Í∏∞ Í≤ÄÏÉâÏñ¥ TOP 10</span>
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:14px;">
            <tr style="background:#f8f9fa;"><th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;">ÏàúÏúÑ</th><th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;">ÌÇ§ÏõåÎìú</th><th style="padding:12px;text-align:right;border-bottom:2px solid #dee2e6;">Í≤ÄÏÉâÎüâ</th></tr>
            ${top10.map((t, i) => `
            <tr style="border-bottom:1px solid #eee;">
                <td style="padding:12px;"><span style="display:inline-block;width:24px;height:24px;background:${i < 3 ? '#F04452' : '#3182F6'};color:white;border-radius:50%;text-align:center;line-height:24px;font-size:12px;font-weight:600;">${i+1}</span></td>
                <td style="padding:12px;font-weight:${i < 3 ? '600' : '400'};">${t.keyword} ${t.change > 20 ? '<span style="color:#F04452;">üî•</span>' : t.change > 0 ? '<span style="color:#30B06E;">‚òëÔ∏è</span>' : ''}</td>
                <td style="padding:12px;text-align:right;color:#666;">${formatNumber(t.searches)}Í±¥</td>
            </tr>`).join('')}
        </table>
    </div>
    ` : ''}

    ${secCategory ? `
    <!-- Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Ïù∏Í∏∞ÎèÑ -->
    <div style="padding:24px;background:#f8f9fa;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
            <span style="font-size:18px;">üì¶</span>
            <span style="font-size:18px;font-weight:700;color:#333;">Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Ïù∏Í∏∞ÎèÑ</span>
        </div>
        ${sortedCategories.map(([cat, val]) => `
        <div style="margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                <span style="font-size:14px;color:#333;">${cat}</span>
                <span style="font-size:14px;color:#666;">${formatNumber(val)}</span>
            </div>
            <div style="background:#e0e0e0;border-radius:4px;height:8px;overflow:hidden;">
                <div style="background:linear-gradient(90deg,#30B06E,#4ADE80);height:100%;width:${Math.round(val/maxCatValue*100)}%;border-radius:4px;"></div>
            </div>
        </div>`).join('')}
    </div>
    ` : ''}

    ${secAnalysis && aiAnalysis ? `
    <!-- AI Ìä∏Î†åÎìú Î∂ÑÏÑù -->
    <div style="padding:24px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px;">
            <span style="font-size:18px;">üí°</span>
            <span style="font-size:18px;font-weight:700;color:#333;">Ïù¥Î≤à Ï£º Ìä∏Î†åÎìú Î∂ÑÏÑù</span>
        </div>
        <div style="background:#FFF9E6;border-left:4px solid #F59F00;padding:16px;border-radius:0 8px 8px 0;line-height:1.8;font-size:14px;color:#333;">
            ${aiAnalysis.replace(/\n/g, '<br>')}
        </div>
    </div>
    ` : ''}

    ${secPromo ? `
    <!-- ÌîÑÎ°úÎ™®ÏÖò Î∞∞ÎÑà -->
    <div style="padding:24px;background:linear-gradient(135deg,#EDE9FE,#FBE7F3);">
        <div style="text-align:center;">
            <div style="font-size:14px;color:#7C3AED;margin-bottom:8px;">üíú ÎπÑÎìúÎ∞îÏù¥ ÏÖÄÎ†âÌä∏</div>
            <div style="font-size:20px;font-weight:700;color:#333;margin-bottom:8px;">20ÎÖÑÍ∞ÑÏùò Îç∞Ïù¥ÌÑ∞Î•º Î∞îÌÉïÏúºÎ°ú ÏóÑÏÑ†Ìïú<br>Ïù∏Í∏∞ ÏÉÅÌíàÎì§ÏùÑ ÎßåÎÇòÎ≥¥ÏÑ∏Ïöî!</div>
            <a href="https://bidbuy.co.kr" style="display:inline-block;background:#7C3AED;color:white;padding:12px 32px;border-radius:24px;text-decoration:none;font-weight:600;margin-top:12px;">üõí Ïù∏Í∏∞ ÏÉÅÌíà Î∞îÎ°ú Î≥¥Í∏∞</a>
            <div style="font-size:12px;color:#666;margin-top:12px;">ÎπÑÎìúÎ∞îÏù¥ ÏÖÄÎ†âÌä∏ÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî</div>
        </div>
    </div>
    ` : ''}

    <!-- Ìë∏ÌÑ∞ -->
    <div style="padding:24px;background:#333;text-align:center;">
        <div style="color:white;font-weight:600;margin-bottom:8px;">ÎπÑÎìúÎ∞îÏù¥ÏΩîÎ¶¨ÏïÑ | 20ÎÖÑ Ï†ÑÌÜµ ÏùºÎ≥∏ Íµ¨Îß§ÎåÄÌñâ</div>
        <div style="color:#999;font-size:12px;">Î≥∏ Î©îÏùºÏùÄ Ï†ïÎ≥¥ Ï†úÍ≥µ Î™©Ï†ÅÏúºÎ°ú Î∞úÏÜ°ÎêòÏóàÏäµÎãàÎã§.</div>
        <div style="color:#666;font-size:11px;margin-top:12px;">ÏàòÏã†Í±∞Î∂Ä | Î¨∏ÏùòÌïòÍ∏∞</div>
    </div>
</div>
</body>
</html>`;
        }

        // ============================================
        // Íµ¨ÎèÖÏûê Í¥ÄÎ¶¨
        // ============================================
        function renderSubscribers() {
            const active = state.subscribers.filter(s => s.subscribed).length;
            const inactive = state.subscribers.length - active;

            return `
            <div class="page-header">
                <h1 class="page-title">Íµ¨ÎèÖÏûê Í¥ÄÎ¶¨</h1>
                <p class="page-desc">Îâ¥Ïä§Î†àÌÑ∞ Íµ¨ÎèÖÏûêÎ•º Í¥ÄÎ¶¨Ìï©ÎãàÎã§</p>
            </div>

            <div class="grid-3">
                <div class="stat-card">
                    <div class="stat-label">Ï†ÑÏ≤¥ Íµ¨ÎèÖÏûê</div>
                    <div class="stat-value">${state.subscribers.length}Î™Ö</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ÌôúÏÑ± Íµ¨ÎèÖÏûê</div>
                    <div class="stat-value" style="color:var(--toss-green);">${active}Î™Ö</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Íµ¨ÎèÖ Ìï¥ÏßÄ</div>
                    <div class="stat-value" style="color:var(--toss-red);">${inactive}Î™Ö</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Íµ¨ÎèÖÏûê Î™©Î°ù</h3>
                    <button class="btn btn-primary btn-sm" id="addSubscriberBtn">+ Ï∂îÍ∞Ä</button>
                </div>

                ${state.subscribers.length > 0 ? `
                <table class="table">
                    <thead><tr><th>Ïù¥Î¶Ñ</th><th>Ïù¥Î©îÏùº</th><th>Í∞ÄÏûÖÏùº</th><th>ÏÉÅÌÉú</th><th>Í¥ÄÎ¶¨</th></tr></thead>
                    <tbody>
                        ${state.subscribers.map(s => `
                        <tr>
                            <td><strong>${s.name}</strong></td>
                            <td>${s.email}</td>
                            <td>${s.createdAt}</td>
                            <td><span class="badge ${s.subscribed ? 'badge-green' : 'badge-red'}">${s.subscribed ? 'Íµ¨ÎèÖÏ§ë' : 'Ìï¥ÏßÄ'}</span></td>
                            <td>
                                <button class="btn btn-secondary btn-sm toggle-sub" data-id="${s.id}">${s.subscribed ? 'Ìï¥ÏßÄ' : 'Ïû¨Íµ¨ÎèÖ'}</button>
                                <button class="btn btn-danger btn-sm delete-sub" data-id="${s.id}">ÏÇ≠Ï†ú</button>
                            </td>
                        </tr>
                        `).join('')}
                    </tbody>
                </table>
                ` : '<div class="empty-state"><div class="empty-icon">üë•</div><div class="empty-title">Íµ¨ÎèÖÏûê ÏóÜÏùå</div></div>'}
            </div>`;
        }

        // ============================================
        // ÏÑ§Ï†ï
        // ============================================
        function renderSettings() {
            const hasApiKey = state.geminiApiKey.length > 10;

            return `
            <div class="page-header">
                <h1 class="page-title">ÏÑ§Ï†ï</h1>
                <p class="page-desc">ÏãúÏä§ÌÖú ÏÑ§Ï†ïÏùÑ Í¥ÄÎ¶¨Ìï©ÎãàÎã§</p>
            </div>

            <div class="card" style="max-width:640px;">
                <div class="card-header">
                    <h3 class="card-title">ü§ñ Gemini AI ÏÑ§Ï†ï</h3>
                    <span class="badge ${hasApiKey ? 'badge-green' : 'badge-red'}">${hasApiKey ? 'Ïó∞Í≤∞Îê®' : 'ÎØ∏Ïó∞Í≤∞'}</span>
                </div>

                <div class="info-box blue">
                    <strong>AI ÏΩòÌÖêÏ∏† ÏÉùÏÑ±</strong>ÏùÑ ÏÇ¨Ïö©ÌïòÎ†§Î©¥ Google Gemini API ÌÇ§Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§.
                </div>

                <div class="form-group">
                    <label class="form-label">Gemini API ÌÇ§</label>
                    <div style="display:flex;gap:8px;">
                        <input type="${state.showApiKey ? 'text' : 'password'}" id="apiKeyInput" class="form-input"
                               value="${state.geminiApiKey}" placeholder="AIzaSy..." style="flex:1;">
                        <button class="btn btn-secondary" id="toggleKeyBtn">${state.showApiKey ? 'Ïà®Í∏∞Í∏∞' : 'Î≥¥Í∏∞'}</button>
                    </div>
                </div>

                <div style="display:flex;gap:12px;margin-bottom:20px;">
                    <button class="btn btn-primary" id="saveApiKeyBtn" style="flex:1;">üíæ Ï†ÄÏû•</button>
                    <button class="btn btn-secondary" id="testApiKeyBtn" style="flex:1;">üîç Ïó∞Í≤∞ ÌÖåÏä§Ìä∏</button>
                </div>

                <div style="background:var(--toss-gray-50);padding:16px;border-radius:12px;">
                    <p style="font-weight:600;margin-bottom:12px;">üìã API ÌÇ§ Î∞úÍ∏â Î∞©Î≤ï</p>
                    <ol style="font-size:14px;color:var(--toss-gray-600);line-height:2;padding-left:20px;">
                        <li><a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:var(--toss-blue);">Google AI Studio</a> Ï†ëÏÜç</li>
                        <li>Google Í≥ÑÏ†ïÏúºÎ°ú Î°úÍ∑∏Ïù∏</li>
                        <li>"Create API Key" Î≤ÑÌäº ÌÅ¥Î¶≠</li>
                        <li>ÏÉùÏÑ±Îêú API ÌÇ§Î•º ÏúÑÏóê Î∂ôÏó¨ÎÑ£Í∏∞</li>
                    </ol>
                </div>
            </div>

            <div class="card" style="max-width:640px;">
                <div class="card-header">
                    <h3 class="card-title">üìß Ïä§Ìã∞ÎπÑ Ïù¥Î©îÏùº API ÏÑ§Ï†ï</h3>
                    <span class="badge ${state.stibeeApiKey.length > 10 ? 'badge-green' : 'badge-red'}">${state.stibeeApiKey.length > 10 ? 'Ïó∞Í≤∞Îê®' : 'ÎØ∏Ïó∞Í≤∞'}</span>
                </div>

                <div class="info-box blue">
                    <strong>Ïù¥Î©îÏùº ÎåÄÎüâ Î∞úÏÜ°</strong>ÏùÑ ÏúÑÌï¥ Ïä§Ìã∞ÎπÑ(Stibee) API ÌÇ§Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§.
                </div>

                <div class="form-group">
                    <label class="form-label">Ïä§Ìã∞ÎπÑ API ÌÇ§</label>
                    <div style="display:flex;gap:8px;">
                        <input type="${state.showStibeeKey ? 'text' : 'password'}" id="stibeeKeyInput" class="form-input"
                               value="${state.stibeeApiKey}" placeholder="API ÌÇ§ ÏûÖÎ†•..." style="flex:1;">
                        <button class="btn btn-secondary" id="toggleStibeeKeyBtn">${state.showStibeeKey ? 'Ïà®Í∏∞Í∏∞' : 'Î≥¥Í∏∞'}</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ï£ºÏÜåÎ°ù ID (listId)</label>
                    <input type="text" id="stibeeListInput" class="form-input"
                           value="${state.stibeeListId}" placeholder="Ï£ºÏÜåÎ°ù ID (URLÏóêÏÑú ÌôïÏù∏)">
                </div>

                <div style="display:flex;gap:12px;margin-bottom:20px;">
                    <button class="btn btn-primary" id="saveStibeeBtn" style="flex:1;">üíæ Ï†ÄÏû•</button>
                    <button class="btn btn-secondary" id="testStibeeBtn" style="flex:1;">üîç Ïó∞Í≤∞ ÌÖåÏä§Ìä∏</button>
                </div>

                <div style="background:var(--toss-gray-50);padding:16px;border-radius:12px;">
                    <p style="font-weight:600;margin-bottom:12px;">üìã Ïä§Ìã∞ÎπÑ API ÏÑ§Ï†ï Î∞©Î≤ï</p>
                    <ol style="font-size:14px;color:var(--toss-gray-600);line-height:2;padding-left:20px;">
                        <li><a href="https://stibee.com" target="_blank" style="color:var(--toss-blue);">Ïä§Ìã∞ÎπÑ</a> Î°úÍ∑∏Ïù∏</li>
                        <li>ÏõåÌÅ¨Ïä§ÌéòÏù¥Ïä§ ÏÑ§Ï†ï ‚Üí API ÌÇ§ ‚Üí ÏÉàÎ°ú ÎßåÎì§Í∏∞</li>
                        <li>Ï£ºÏÜåÎ°ù URLÏóêÏÑú lists/ Îí§ Ïà´ÏûêÍ∞Ä Ï£ºÏÜåÎ°ù ID</li>
                        <li>ÏÉùÏÑ±Îêú Í∞íÎì§ÏùÑ ÏúÑÏóê ÏûÖÎ†•</li>
                    </ol>
                </div>
            </div>

            <div class="card" style="max-width:640px;">
                <div class="card-header">
                    <h3 class="card-title">üíæ Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨</h3>
                </div>

                <!-- ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞ ÌòÑÌô© -->
                <div style="background:var(--toss-gray-50);padding:16px;border-radius:12px;margin-bottom:20px;">
                    <p style="font-weight:600;margin-bottom:12px;">üìä ÌòÑÏû¨ Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞</p>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;font-size:14px;">
                        <div style="display:flex;justify-content:space-between;">
                            <span style="color:var(--toss-gray-600);">ÌåêÎß§ Îç∞Ïù¥ÌÑ∞</span>
                            <strong>${state.salesData.length > 0 ? formatNumber(state.salesData.length) + 'Í±¥' : 'ÏóÜÏùå'}</strong>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span style="color:var(--toss-gray-600);">Ìä∏Î†åÎìú ÌÇ§ÏõåÎìú</span>
                            <strong>${state.trendData.length > 0 ? state.trendData.length + 'Í∞ú' : 'ÏóÜÏùå'}</strong>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span style="color:var(--toss-gray-600);">Ïª¨Îüº Îß§Ìïë</span>
                            <strong>${columnMapping.category1 ? 'ÏÑ§Ï†ïÎê®' : 'ÎØ∏ÏÑ§Ï†ï'}</strong>
                        </div>
                        <div style="display:flex;justify-content:space-between;">
                            <span style="color:var(--toss-gray-600);">API ÌÇ§</span>
                            <strong>${state.geminiApiKey.length > 10 ? 'Ï†ÄÏû•Îê®' : 'ÎØ∏Ï†ÄÏû•'}</strong>
                        </div>
                    </div>
                </div>

                <!-- Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ -->
                <div style="border:1px solid var(--toss-gray-200);border-radius:12px;padding:16px;margin-bottom:16px;">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                        <span style="font-size:24px;">üì•</span>
                        <div>
                            <p style="font-weight:600;margin:0;">Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ</p>
                            <p style="font-size:13px;color:var(--toss-gray-500);margin:4px 0 0 0;">ÌåêÎß§ Îç∞Ïù¥ÌÑ∞, Ìä∏Î†åÎìú, ÏÑ§Ï†ïÏùÑ JSON ÌååÏùºÎ°ú Ï†ÄÏû•Ìï©ÎãàÎã§</p>
                        </div>
                    </div>
                    <button class="btn btn-secondary" id="exportBtn" style="width:100%;">üíæ Î∞±ÏóÖ ÌååÏùº Îã§Ïö¥Î°úÎìú</button>
                </div>

                <!-- Îç∞Ïù¥ÌÑ∞ Î≥µÏõê -->
                <div style="border:1px solid var(--toss-gray-200);border-radius:12px;padding:16px;margin-bottom:16px;">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                        <span style="font-size:24px;">üì§</span>
                        <div>
                            <p style="font-weight:600;margin:0;">Îç∞Ïù¥ÌÑ∞ Î≥µÏõê</p>
                            <p style="font-size:13px;color:var(--toss-gray-500);margin:4px 0 0 0;">Î∞±ÏóÖ ÌååÏùºÏóêÏÑú Îç∞Ïù¥ÌÑ∞Î•º Î≥µÏõêÌï©ÎãàÎã§</p>
                        </div>
                    </div>
                    <input type="file" id="importFileInput" accept=".json" style="display:none;">
                    <button class="btn btn-secondary" id="importBtn" style="width:100%;">üìÇ Î∞±ÏóÖ ÌååÏùº Î∂àÎü¨Ïò§Í∏∞</button>
                </div>

                <!-- Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî (ÏúÑÌóò) -->
                <div style="border:2px solid var(--toss-red);border-radius:12px;padding:16px;background:rgba(240,68,82,0.05);">
                    <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                        <span style="font-size:24px;">‚ö†Ô∏è</span>
                        <div>
                            <p style="font-weight:600;margin:0;color:var(--toss-red);">ÏóÖÎ°úÎìú Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî</p>
                            <p style="font-size:13px;color:var(--toss-gray-600);margin:4px 0 0 0;">ÏóÖÎ°úÎìúÎêú ÌåêÎß§ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§. API ÌÇ§Îäî Ïú†ÏßÄÎê©ÎãàÎã§.</p>
                        </div>
                    </div>
                    <div class="info-box yellow" style="margin-bottom:12px;padding:12px;">
                        <strong>ÏÇ≠Ï†úÎêòÎäî Ìï≠Î™©:</strong><br>
                        ‚Ä¢ ÏóÖÎ°úÎìúÎêú ÌåêÎß§ Îç∞Ïù¥ÌÑ∞ (${formatNumber(state.salesData.length)}Í±¥)<br>
                        ‚Ä¢ Ìä∏Î†åÎìú ÌÇ§ÏõåÎìú (${state.trendData.length}Í∞ú)<br>
                        ‚Ä¢ Ïª¨Îüº Îß§Ìïë ÏÑ§Ï†ï<br>
                        ‚Ä¢ ÏÉùÏÑ±Îêú Îâ¥Ïä§Î†àÌÑ∞<br><br>
                        <strong style="color:var(--toss-green);">‚úì Ïú†ÏßÄÎêòÎäî Ìï≠Î™©:</strong><br>
                        ‚Ä¢ Gemini API ÌÇ§<br>
                        ‚Ä¢ Ïä§Ìã∞ÎπÑ API ÏÑ§Ï†ï
                    </div>
                    <button class="btn btn-danger" id="resetBtn" style="width:100%;">üóëÔ∏è ÏóÖÎ°úÎìú Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú</button>
                </div>
            </div>`;
        }

        // ============================================
        // Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
        // ============================================
        function attachEvents() {
            // Î°úÍ∑∏Ïù∏
            document.getElementById('loginForm')?.addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('loginId').value;
                const pw = document.getElementById('loginPw').value;
                if (id === 'admin' && pw === 'admin123') {
                    state.isLoggedIn = true;
                    localStorage.setItem('bidbuy_logged_in', 'true');
                    render();
                    showToast('Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ');
                } else {
                    showToast('ÏïÑÏù¥Îîî ÎòêÎäî ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§');
                }
            });

            // Î°úÍ∑∏ÏïÑÏõÉ
            document.getElementById('logoutBtn')?.addEventListener('click', () => {
                state.isLoggedIn = false;
                localStorage.setItem('bidbuy_logged_in', 'false');
                render();
            });

            // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
            document.querySelectorAll('[data-page]').forEach(el => {
                el.addEventListener('click', () => {
                    state.currentPage = el.dataset.page;
                    render();
                });
            });

            // ÌååÏùº ÏóÖÎ°úÎìú
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            if (uploadZone && fileInput) {
                uploadZone.addEventListener('click', () => fileInput.click());
                uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('dragover'); });
                uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
                uploadZone.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file) await handleFileUpload(file);
                });
                fileInput.addEventListener('change', async (e) => {
                    if (e.target.files[0]) await handleFileUpload(e.target.files[0]);
                });
            }

            // Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Î≤ÑÌäº
            document.getElementById('analyzeBtn')?.addEventListener('click', () => {
                state.currentPage = 'analysis';
                render();
                showToast('Î∂ÑÏÑù ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§');
            });

            // Ïπ¥ÌÖåÍ≥†Î¶¨ Depth ÏÑ†ÌÉù (Î∂ÑÏÑù ÌéòÏù¥ÏßÄ)
            document.querySelectorAll('.depth-selector').forEach(btn => {
                btn.addEventListener('click', () => {
                    const newDepth = parseInt(btn.dataset.depth);
                    analysisCategoryDepth = newDepth;
                    window._analyzedOnce = false; // ÎîîÎ≤ÑÍ∑∏ Î°úÍ∑∏ Ïû¨ÌôúÏÑ±Ìôî
                    console.log('üìä Î∂ÑÏÑù Depth Î≥ÄÍ≤Ω:', newDepth);
                    render();
                    showToast(`Î∂ÑÏÑù Í∏∞Ï§ÄÏù¥ Depth ${newDepth}Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§`, 'success');
                });
            });

            // ÏõîÎ≥Ñ ÌïÑÌÑ∞ ÏÑ†ÌÉù
            document.querySelectorAll('.month-selector').forEach(btn => {
                btn.addEventListener('click', () => {
                    const month = btn.dataset.month;
                    selectedMonth = month || null;
                    window._analyzedOnce = false;
                    console.log('üìÖ ÏõîÎ≥Ñ ÌïÑÌÑ∞ Î≥ÄÍ≤Ω:', selectedMonth || 'Ï†ÑÏ≤¥');

                    // Ïõî Î≥ÄÍ≤Ω Ïãú Ìä∏Î†åÎìú Îç∞Ïù¥ÌÑ∞ÎèÑ Ïû¨Ï∂îÏ∂ú
                    if (state.salesData && state.salesData.length > 0) {
                        const extractedTrends = extractTrendFromData();
                        if (extractedTrends.length > 0) {
                            state.trendData = extractedTrends;
                        }
                    }

                    render();
                    const monthLabel = selectedMonth ? `${parseInt(selectedMonth.split('-')[1])}Ïõî` : 'Ï†ÑÏ≤¥ Í∏∞Í∞Ñ';
                    showToast(`${monthLabel} Îç∞Ïù¥ÌÑ∞Î°ú Î∂ÑÏÑùÌï©ÎãàÎã§`, 'success');
                });
            });

            // Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî Î≤ÑÌäº
            document.getElementById('resetDataBtn')?.addEventListener('click', async () => {
                if (confirm('Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n‚Ä¢ ÏóÖÎ°úÎìúÎêú ÌåêÎß§ Îç∞Ïù¥ÌÑ∞\n‚Ä¢ Ìä∏Î†åÎìú Îç∞Ïù¥ÌÑ∞\n‚Ä¢ Ïª¨Îüº Îß§Ìïë ÏÑ§Ï†ï\n\nÏù¥ Î™®Îëê ÏÇ≠Ï†úÎê©ÎãàÎã§.')) {
                    try {
                        // IndexedDB Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
                        await saveSalesData([]);
                        state.salesData = [];

                        // Ìä∏Î†åÎìú Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
                        state.trendData = [];
                        localStorage.removeItem('bidbuy_trends');

                        // Ïª¨Îüº Îß§Ìïë Ï¥àÍ∏∞Ìôî
                        columnMapping = { product: null, category: null, sales: null, site: null, date: null, category1: null, category2: null, category3: null, category4: null };
                        localStorage.removeItem('bidbuy_column_mapping');

                        // ÏõîÎ≥Ñ ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
                        selectedMonth = null;
                        window._analyzedOnce = false;

                        render();
                        showToast('‚úÖ Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§', 'success');
                    } catch (err) {
                        console.error('Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', err);
                        showToast('Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§', 'error');
                    }
                }
            });

            // Ìä∏Î†åÎìú Ï†ÑÏ≤¥Î≥¥Í∏∞ ÎßÅÌÅ¨
            document.querySelectorAll('.trend-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    state.currentPage = 'trends';
                    render();
                });
            });

            // Ìä∏Î†åÎìú Ïû¨Ï∂îÏ∂ú Î≤ÑÌäº
            document.getElementById('refreshTrendBtn')?.addEventListener('click', () => {
                if (state.salesData && state.salesData.length > 0) {
                    const extractedTrends = extractTrendFromData();
                    if (extractedTrends.length > 0) {
                        state.trendData = extractedTrends;
                        localStorage.setItem('bidbuy_trends', JSON.stringify(state.trendData));
                        render();
                        showToast(`‚úÖ TOP ${extractedTrends.length} Ìä∏Î†åÎìú ÌÇ§ÏõåÎìúÍ∞Ä Ïû¨Ï∂îÏ∂úÎêòÏóàÏäµÎãàÎã§!`, 'success');
                    } else {
                        showToast('Ìä∏Î†åÎìú Ï∂îÏ∂úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Ïπ¥ÌÖåÍ≥†Î¶¨ Îß§ÌïëÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                    }
                } else {
                    showToast('Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä ÏóëÏÖÄ ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                }
            });

            // Ïª¨Îüº Îß§Ìïë Ï†ÄÏû•
            document.getElementById('saveColumnMappingBtn')?.addEventListener('click', () => {
                document.querySelectorAll('.column-select').forEach(select => {
                    const type = select.dataset.type;
                    columnMapping[type] = select.value || null;
                });
                localStorage.setItem('bidbuy_column_mapping', JSON.stringify(columnMapping));

                // Îß§Ìïë Ï†ÄÏû• ÌõÑ Ìä∏Î†åÎìúÎèÑ Ïû¨Ï∂îÏ∂ú
                if (state.salesData && state.salesData.length > 0) {
                    const extractedTrends = extractTrendFromData();
                    if (extractedTrends.length > 0) {
                        state.trendData = extractedTrends;
                        localStorage.setItem('bidbuy_trends', JSON.stringify(state.trendData));
                    }
                }

                showToast('‚úÖ Ïª¨Îüº Îß§ÌïëÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 'success');
                state.currentPage = 'analysis';
                render();
            });

            // ÏûêÎèô Í∞êÏßÄ Î≤ÑÌäº
            document.getElementById('autoDetectBtn')?.addEventListener('click', () => {
                if (state.salesData.length > 0) {
                    detectColumns(state.salesData);

                    // ÏûêÎèô Í∞êÏßÄ ÌõÑ Ìä∏Î†åÎìúÎèÑ Ïû¨Ï∂îÏ∂ú
                    const extractedTrends = extractTrendFromData();
                    if (extractedTrends.length > 0) {
                        state.trendData = extractedTrends;
                        localStorage.setItem('bidbuy_trends', JSON.stringify(state.trendData));
                        console.log('‚úÖ ÏûêÎèô Í∞êÏßÄ ÌõÑ Ìä∏Î†åÎìú Ï∂îÏ∂ú:', extractedTrends.length, 'Í∞ú');
                    }

                    render();
                    showToast('‚úÖ Ïª¨ÎüºÏù¥ ÏûêÎèô Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§!', 'success');
                }
            });

            // Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
            document.getElementById('clearDataBtn')?.addEventListener('click', async () => {
                if (confirm('ÏóÖÎ°úÎìúÎêú Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                    state.salesData = [];
                    // IndexedDBÏóêÏÑúÎèÑ ÏÇ≠Ï†ú
                    try {
                        await saveSalesData([]);
                        showToast('‚úÖ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§', 'success');
                    } catch (err) {
                        console.error('ÏÇ≠Ï†ú Ïã§Ìå®:', err);
                    }
                    render();
                }
            });

            // Ìä∏Î†åÎìú Ï∂îÍ∞Ä
            document.getElementById('addTrendBtn')?.addEventListener('click', () => {
                const keyword = prompt('ÌÇ§ÏõåÎìú:');
                if (keyword) {
                    const newId = Math.max(0, ...state.trendData.map(t => t.id)) + 1;
                    state.trendData.push({
                        id: newId,
                        keyword,
                        category: prompt('Ïπ¥ÌÖåÍ≥†Î¶¨:') || 'Í∏∞ÌÉÄ',
                        searches: parseInt(prompt('Í≤ÄÏÉâÎüâ:')) || 0,
                        change: parseInt(prompt('Î≥ÄÌôîÏú®(%):')) || 0,
                        price: parseInt(prompt('Í∞ÄÍ≤©(Ïóî):')) || 0
                    });
                    saveState();
                    render();
                    showToast('Ìä∏Î†åÎìúÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§');
                }
            });

            // Ìä∏Î†åÎìú ÏÇ≠Ï†ú
            document.querySelectorAll('.delete-trend').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                        state.trendData = state.trendData.filter(t => t.id !== parseInt(btn.dataset.id));
                        saveState();
                        render();
                        showToast('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
                    }
                });
            });

            // Ìä∏Î†åÎìú ÏàòÏ†ï
            document.querySelectorAll('.edit-trend').forEach(btn => {
                btn.addEventListener('click', () => {
                    const t = state.trendData.find(x => x.id === parseInt(btn.dataset.id));
                    if (t) {
                        t.keyword = prompt('ÌÇ§ÏõåÎìú:', t.keyword) || t.keyword;
                        t.category = prompt('Ïπ¥ÌÖåÍ≥†Î¶¨:', t.category) || t.category;
                        t.searches = parseInt(prompt('Í≤ÄÏÉâÎüâ:', t.searches)) || t.searches;
                        t.change = parseInt(prompt('Î≥ÄÌôîÏú®(%):', t.change)) ?? t.change;
                        saveState();
                        render();
                        showToast('ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§');
                    }
                });
            });

            // AI ÏΩòÌÖêÏ∏† ÏÉùÏÑ±
            document.getElementById('generateBtn')?.addEventListener('click', async () => {
                state.isGenerating = true;
                render();

                try {
                    const type = document.getElementById('contentType')?.value || 'newsletter';
                    const prompt = buildPrompt(type);
                    const content = await callGemini(prompt);
                    state.generatedContent = content || 'ÏÉùÏÑ± Ïã§Ìå®';
                } catch (err) {
                    state.generatedContent = 'Ïò§Î•ò: ' + err.message;
                }

                state.isGenerating = false;
                render();
            });

            // ÏΩòÌÖêÏ∏† Î≥µÏÇ¨
            document.getElementById('copyContentBtn')?.addEventListener('click', () => {
                if (state.generatedContent) {
                    navigator.clipboard.writeText(state.generatedContent);
                    showToast('Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§');
                }
            });

            // ========== ÏÉà Îâ¥Ïä§Î†àÌÑ∞ ÏãúÏä§ÌÖú ==========

            // Îâ¥Ïä§Î†àÌÑ∞ ÏÉùÏÑ±
            document.getElementById('generateNewsletterBtn')?.addEventListener('click', async () => {
                // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Ìä∏Î†åÎìú Ïû¨Ï∂îÏ∂ú (Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥)
                if (state.salesData && state.salesData.length > 0) {
                    const extractedTrends = extractTrendFromData();
                    if (extractedTrends.length > 0) {
                        state.trendData = extractedTrends;
                        localStorage.setItem('bidbuy_trends', JSON.stringify(state.trendData));
                        console.log('üìä Îâ¥Ïä§Î†àÌÑ∞Ïö© Ìä∏Î†åÎìú Ï∂îÏ∂ú:', extractedTrends.length, 'Í∞ú');
                    }
                }

                if (!state.trendData || state.trendData.length === 0) {
                    showToast('Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. Î®ºÏ†Ä ÏóëÏÖÄ ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                    return;
                }

                state.isGenerating = true;
                render();

                try {
                    // AI Ìä∏Î†åÎìú Î∂ÑÏÑù ÏÉùÏÑ±
                    const secAnalysis = document.getElementById('secAnalysis')?.checked;
                    let aiAnalysis = '';

                    // Ïã§Ï†ú Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Í≤∞Í≥º Í∞ÄÏ†∏Ïò§Í∏∞
                    const analysis = analyzeCategories(1); // depth 1 (ÎåÄÎ∂ÑÎ•ò)
                    const topCategories = Object.entries(analysis.stats)
                        .sort((a, b) => b[1].sales - a[1].sales)
                        .slice(0, 5)
                        .map(([cat, data]) => `${cat}: ${formatCurrency(data.sales)} (${data.count}Í±¥)`);

                    if (secAnalysis && state.geminiApiKey) {
                        // Ìä∏Î†åÎìú Îç∞Ïù¥ÌÑ∞ ÏàòÏóê Îî∞Îùº Î∂ÑÏÑùÌï† Í∞úÏàò Í≤∞Ï†ï
                        const trendCount = state.trendData.length;
                        const topTrends = state.trendData.slice(0, Math.min(trendCount, 30));

                        // TOP 1~3 ÏÉÅÏÑ∏ Î∂ÑÏÑùÏö© Îç∞Ïù¥ÌÑ∞
                        const top3 = topTrends.slice(0, 3);
                        // TOP 4~10 ÏöîÏïΩ
                        const top4to10 = topTrends.slice(3, 10);
                        // Í∑∏ Ïù¥ÌõÑ ÌÇ§ÏõåÎìúÎì§
                        const restTrends = topTrends.slice(10);

                        // Í∞ÄÍ≤©ÎåÄ Î∂ÑÌè¨ Î∂ÑÏÑù
                        const priceRanges = {
                            under10k: topTrends.filter(t => t.price < 10000).length,
                            '10kTo20k': topTrends.filter(t => t.price >= 10000 && t.price < 20000).length,
                            over20k: topTrends.filter(t => t.price >= 20000).length
                        };

                        // Î©¥ÏÑ∏ÌïúÎèÑ(15ÎßåÏóî) Í¥ÄÎ†® Î∂ÑÏÑù
                        const dutyFreeLimit = 150000; // Î©¥ÏÑ∏ ÌïúÎèÑ
                        const avgPrice = analysis.avgPrice;
                        const itemsPerDutyFree = avgPrice > 0 ? Math.floor(dutyFreeLimit / avgPrice) : 0;

                        const prompt = `ÎãπÏã†ÏùÄ ÎπÑÎìúÎ∞îÏù¥ÏΩîÎ¶¨ÏïÑÏùò ÏùºÎ≥∏ Íµ¨Îß§ÎåÄÌñâ/Í≤ΩÎß§ÎåÄÌñâ Ï†ÑÎ¨∏ ÏóêÎîîÌÑ∞ÏûÖÎãàÎã§.
ÏóêÏù¥Î∏îÎ¶¨, ÏïÑÎ¨¥Îìú Í∞ôÏùÄ Ïª§Î®∏Ïä§ Îâ¥Ïä§Î†àÌÑ∞ Ïä§ÌÉÄÏùºÎ°ú ÏπúÍ∑ºÌïòÎ©¥ÏÑúÎèÑ Ï†ÑÎ¨∏Ï†ÅÏù∏ Ìä∏Î†åÎìú Î∂ÑÏÑùÏùÑ ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.

===== Ïã§Ï†ú Ï£ºÎ¨∏ Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Í≤∞Í≥º =====

üìä Ïù¥Î≤à Í∏∞Í∞Ñ Í±∞Îûò ÌòÑÌô©:
- Î∂ÑÏÑù Í∏∞Í∞Ñ: ${selectedMonth ? parseInt(selectedMonth.split('-')[1]) + 'Ïõî' : 'Ï†ÑÏ≤¥ Í∏∞Í∞Ñ'}
- Ï¥ù Í±∞ÎûòÍ±¥Ïàò: ${formatNumber(analysis.totalQty)}Í±¥
- Ï¥ù Í±∞ÎûòÍ∏àÏï°: ${formatCurrency(analysis.totalSales)}
- ÌèâÍ∑† Îã®Í∞Ä: ${formatCurrency(analysis.avgPrice)} (Î©¥ÏÑ∏ ÌïúÎèÑ 15ÎßåÏóî Í∏∞Ï§Ä ÏïΩ ${itemsPerDutyFree}Í∞ú Íµ¨Îß§ Í∞ÄÎä•)

üèÜ TOP 3 Ïù∏Í∏∞ ÌÇ§ÏõåÎìú (ÏßëÏ§ë Î∂ÑÏÑù ÌïÑÏöî):
${top3.map((t, i) => `${i+1}ÏúÑ. "${t.keyword}"
   - ÏÉÅÏúÑ Ïπ¥ÌÖåÍ≥†Î¶¨: ${t.category}
   - Í±∞ÎûòÍ±¥Ïàò: ${t.searches}Í±¥
   - ÌèâÍ∑†Îã®Í∞Ä: ${formatCurrency(t.price)}`).join('\n')}

üìà TOP 4~10 Ï£ºÏöî ÌÇ§ÏõåÎìú:
${top4to10.map((t, i) => `${i+4}ÏúÑ. ${t.keyword} (${t.category}) - ${t.searches}Í±¥, ${formatCurrency(t.price)}`).join('\n')}

${restTrends.length > 0 ? `üìã Í∏∞ÌÉÄ Ïù∏Í∏∞ ÌÇ§ÏõåÎìú (11~${10 + restTrends.length}ÏúÑ):
${restTrends.map((t, i) => `${i+11}ÏúÑ. ${t.keyword} (${t.category})`).join(', ')}` : ''}

üí∞ Í∞ÄÍ≤©ÎåÄ Î∂ÑÌè¨:
- 1ÎßåÏóî ÎØ∏Îßå: ${priceRanges.under10k}Í∞ú ÌÇ§ÏõåÎìú
- 1~2ÎßåÏóîÎåÄ: ${priceRanges['10kTo20k']}Í∞ú ÌÇ§ÏõåÎìú
- 2ÎßåÏóî Ïù¥ÏÉÅ: ${priceRanges.over20k}Í∞ú ÌÇ§ÏõåÎìú

üì¶ Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÌåêÎß§ TOP 5:
${topCategories.join('\n')}

===== ÏûëÏÑ± ÏöîÏ≤≠ÏÇ¨Ìï≠ =====

Îã§Ïùå ÌòïÏãùÏúºÎ°ú Îâ¥Ïä§Î†àÌÑ∞ Ìä∏Î†åÎìú Î∂ÑÏÑùÏùÑ ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî:

1. **Ïù∏ÏÇ¨Îßê & ÌïµÏã¨ Ïù∏ÏÇ¨Ïù¥Ìä∏** (2-3Î¨∏Ïû•)
   - "${top3[0]?.category || 'Ïù∏Í∏∞ Ïπ¥ÌÖåÍ≥†Î¶¨'}" Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä 1ÏúÑÏù∏ Ïù¥Ïú†Î•º Îç∞Ïù¥ÌÑ∞Î°ú ÏÑ§Î™Ö
   - Ïù¥Î≤à Í∏∞Í∞Ñ ÌäπÏßïÏ†ÅÏù∏ Ìä∏Î†åÎìú ÏöîÏïΩ

2. **TOP 3 ÌÇ§ÏõåÎìú Ïã¨Ï∏µ Î∂ÑÏÑù** (Í∞Å ÌÇ§ÏõåÎìúÎãπ 2-3Î¨∏Ïû•)
   - Í∞Å ÌÇ§ÏõåÎìúÏùò ÏùºÎ≥∏Ïñ¥ ÏõêÏñ¥Í∞Ä ÏûàÎã§Î©¥ ÌïúÍ∏ÄÎ°ú ÏÑ§Î™Ö (Ïòà: "„Éï„Ç£„ÇÆ„É•„Ç¢(ÌîºÍ∑úÏñ¥)" ‚Üí "ÌîºÍ∑úÏñ¥Îäî...")
   - Ìï¥Îãπ Ï†úÌíàÏù¥ Ïù∏Í∏∞ ÏûàÎäî Ïù¥Ïú†
   - ÌèâÍ∑† Îã®Í∞Ä ÎåÄÎπÑ Íµ¨Îß§ Ìè¨Ïù∏Ìä∏ (Î©¥ÏÑ∏ ÌïúÎèÑ Í≥†Î†§)

3. **Ï£ºÎ™©Ìï† ÎßåÌïú Ìä∏Î†åÎìú** (3-4Î¨∏Ïû•)
   - Í∞ÄÍ≤©ÎåÄÎ≥Ñ Ïù∏Í∏∞ Ï†úÌíà Î∂ÑÏÑù
   - Ïπ¥ÌÖåÍ≥†Î¶¨ Í∞Ñ Ïó∞Í¥ÄÏÑ±Ïù¥ÎÇò ÏãúÏ¶àÎÑê Ìä∏Î†åÎìú

4. **Íµ¨Îß§ ÍøÄÌåÅ** (2-3Î¨∏Ïû•)
   - ÌèâÍ∑† Îã®Í∞Ä ${formatCurrency(analysis.avgPrice)} Í∏∞Ï§Ä Î©¥ÏÑ∏ ÌïúÎèÑ ÎÇ¥ Íµ¨Îß§ Ï†ÑÎûµ
   - ÎπÑÎìúÎ∞îÏù¥ Ïù¥Ïö© Ï∂îÏ≤ú

‚ö†Ô∏è Ï§ëÏöî Ï£ºÏùòÏÇ¨Ìï≠:
- Î∞òÎìúÏãú ÏúÑ Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Ïóê Í∏∞Î∞òÌï¥ÏÑú ÏûëÏÑ± (ÏóÜÎäî ÎÇ¥Ïö© Ï∞ΩÏûë Í∏àÏßÄ)
- ÏùºÎ≥∏Ïñ¥ ÌÇ§ÏõåÎìúÎäî ÌïúÍ∏Ä Î∞úÏùåÍ≥º ÎúªÏùÑ Î≥ëÍ∏∞ (Ïòà: "Áé©ÂÖ∑(Í∞ÑÍµ¨/Ïû•ÎÇúÍ∞ê)")
- "‰∏≠ÂõΩ„ÄÅÈüìÂçäÂ≥∂" Í∞ôÏùÄ Ïñ¥ÏÉâÌïú Î≤àÏó≠ÏùÄ "Ï§ëÍµ≠, ÌïúÍµ≠" ÎòêÎäî ÏõêÎûò ÏùòÎØ∏Ïóê ÎßûÍ≤å ÏûêÏó∞Ïä§ÎüΩÍ≤å ÏàòÏ†ï
- Ïù¥Î™®ÏßÄÎäî ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùå
- Ï†ÑÎ¨∏Ï†ÅÏù¥Î©¥ÏÑúÎèÑ ÏπúÍ∑ºÌïú Ïñ¥Ï°∞
- Ï¥ù 15~20Î¨∏Ïû• Î∂ÑÎüâ`;

                        aiAnalysis = await callGemini(prompt) || '';
                    }

                    // HTML Îâ¥Ïä§Î†àÌÑ∞ ÏÉùÏÑ±
                    state.newsletterHtml = generateNewsletterHtml(aiAnalysis);
                    state.generatedContent = aiAnalysis;
                    showToast('‚úÖ Îâ¥Ïä§Î†àÌÑ∞Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§! (TOP ' + state.trendData.length + ' ÌÇ§ÏõåÎìú Í∏∞Î∞ò)', 'success');
                } catch (err) {
                    console.error('Îâ¥Ïä§Î†àÌÑ∞ ÏÉùÏÑ± Ïò§Î•ò:', err);
                    showToast('ÏÉùÏÑ± Ïò§Î•ò: ' + err.message, 'error');
                }

                state.isGenerating = false;
                render();
            });

            // HTML Î≥µÏÇ¨
            document.getElementById('copyHtmlBtn')?.addEventListener('click', () => {
                if (state.newsletterHtml) {
                    navigator.clipboard.writeText(state.newsletterHtml);
                    showToast('HTMLÏù¥ ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§', 'success');
                }
            });

            // HTML Îã§Ïö¥Î°úÎìú
            document.getElementById('downloadHtmlBtn')?.addEventListener('click', () => {
                if (state.newsletterHtml) {
                    const blob = new Blob([state.newsletterHtml], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `newsletter_${new Date().toISOString().split('T')[0]}.html`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast('HTML ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§', 'success');
                }
            });

            // ÎØ∏Î¶¨Î≥¥Í∏∞
            document.getElementById('previewEmailBtn')?.addEventListener('click', () => {
                if (state.newsletterHtml) {
                    const win = window.open('', '_blank');
                    win.document.write(state.newsletterHtml);
                    win.document.close();
                }
            });

            // Ïä§Ìã∞ÎπÑÎ°ú Î∞úÏÜ° (CORS Î¨∏Ï†úÎ°ú Ïã§Ï†ú Î∞úÏÜ°ÏùÄ ÏÑúÎ≤Ñ ÌïÑÏöî)
            document.getElementById('sendStibeeBtn')?.addEventListener('click', () => {
                if (!state.stibeeApiKey || !state.stibeeListId) {
                    showToast('Ïä§Ìã∞ÎπÑ API ÏÑ§Ï†ïÏùÑ Î®ºÏ†Ä ÏôÑÎ£åÌï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }
                showToast('‚ö†Ô∏è Ïä§Ìã∞ÎπÑ Î∞úÏÜ°ÏùÄ ÏÑúÎ≤Ñ ÌôòÍ≤ΩÏù¥ ÌïÑÏöîÌï©ÎãàÎã§. HTMLÏùÑ Î≥µÏÇ¨ÌïòÏó¨ Ïä§Ìã∞ÎπÑÏóêÏÑú ÏßÅÏ†ë ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
            });

            // Íµ¨ÎèÖÏûê Ï∂îÍ∞Ä
            document.getElementById('addSubscriberBtn')?.addEventListener('click', () => {
                const email = prompt('Ïù¥Î©îÏùº:');
                if (email) {
                    const newId = Math.max(0, ...state.subscribers.map(s => s.id)) + 1;
                    state.subscribers.push({
                        id: newId,
                        email,
                        name: prompt('Ïù¥Î¶Ñ:') || 'ÏùµÎ™Ö',
                        subscribed: true,
                        createdAt: new Date().toISOString().split('T')[0]
                    });
                    saveState();
                    render();
                    showToast('Íµ¨ÎèÖÏûêÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§');
                }
            });

            // Íµ¨ÎèÖÏûê ÌÜ†Í∏Ä
            document.querySelectorAll('.toggle-sub').forEach(btn => {
                btn.addEventListener('click', () => {
                    const s = state.subscribers.find(x => x.id === parseInt(btn.dataset.id));
                    if (s) {
                        s.subscribed = !s.subscribed;
                        saveState();
                        render();
                    }
                });
            });

            // Íµ¨ÎèÖÏûê ÏÇ≠Ï†ú
            document.querySelectorAll('.delete-sub').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (confirm('ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                        state.subscribers = state.subscribers.filter(s => s.id !== parseInt(btn.dataset.id));
                        saveState();
                        render();
                        showToast('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
                    }
                });
            });

            // API ÌÇ§ Ï†ÄÏû•
            document.getElementById('saveApiKeyBtn')?.addEventListener('click', () => {
                const key = document.getElementById('apiKeyInput').value.trim();
                if (!key) {
                    showToast('API ÌÇ§Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }
                state.geminiApiKey = key;
                localStorage.setItem('bidbuy_gemini_key', state.geminiApiKey);
                showToast('‚úÖ API ÌÇ§Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 'success');
                render();
            });

            // API ÌÇ§ ÌÜ†Í∏Ä
            document.getElementById('toggleKeyBtn')?.addEventListener('click', () => {
                state.showApiKey = !state.showApiKey;
                render();
            });

            // API ÌÖåÏä§Ìä∏
            document.getElementById('testApiKeyBtn')?.addEventListener('click', async () => {
                const key = document.getElementById('apiKeyInput').value;
                if (!key) { showToast('API ÌÇ§Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'); return; }

                showToast('Ïó∞Í≤∞ ÌÖåÏä§Ìä∏ Ï§ë...');
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: 'ÌÖåÏä§Ìä∏' }] }], generationConfig: { maxOutputTokens: 10 } })
                    });
                    const data = await res.json();

                    if (data.candidates) {
                        showToast('‚úÖ Ïó∞Í≤∞ ÏÑ±Í≥µ!', 'success');
                        state.geminiApiKey = key;
                        localStorage.setItem('bidbuy_gemini_key', key);
                        render();
                    } else {
                        showToast('‚ùå Ïò§Î•ò: ' + (data.error?.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'), 'error');
                    }
                } catch (err) {
                    showToast('‚ùå Ïó∞Í≤∞ Ïã§Ìå®: ' + err.message, 'error');
                }
            });

            // ========== Ïä§Ìã∞ÎπÑ API ÏÑ§Ï†ï ==========

            // Ïä§Ìã∞ÎπÑ API Ï†ÄÏû•
            document.getElementById('saveStibeeBtn')?.addEventListener('click', () => {
                const key = document.getElementById('stibeeKeyInput')?.value.trim();
                const listId = document.getElementById('stibeeListInput')?.value.trim();

                if (!key) {
                    showToast('Ïä§Ìã∞ÎπÑ API ÌÇ§Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }

                state.stibeeApiKey = key;
                state.stibeeListId = listId;
                localStorage.setItem('bidbuy_stibee_key', key);
                localStorage.setItem('bidbuy_stibee_list', listId);
                showToast('‚úÖ Ïä§Ìã∞ÎπÑ API ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 'success');
                render();
            });

            // Ïä§Ìã∞ÎπÑ API ÌÇ§ ÌÜ†Í∏Ä
            document.getElementById('toggleStibeeKeyBtn')?.addEventListener('click', () => {
                state.showStibeeKey = !state.showStibeeKey;
                render();
            });

            // Ïä§Ìã∞ÎπÑ Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
            document.getElementById('testStibeeBtn')?.addEventListener('click', async () => {
                const key = document.getElementById('stibeeKeyInput')?.value;
                if (!key) {
                    showToast('Ïä§Ìã∞ÎπÑ API ÌÇ§Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                    return;
                }
                showToast('‚ö†Ô∏è Ïä§Ìã∞ÎπÑ API ÌÖåÏä§Ìä∏Îäî CORS Ï†ïÏ±ÖÏúºÎ°ú Ïù∏Ìï¥ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú ÏßÅÏ†ë Î∂àÍ∞ÄÎä•Ìï©ÎãàÎã§. ÏÑúÎ≤Ñ ÌôòÍ≤ΩÏóêÏÑú ÌÖåÏä§Ìä∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
            });

            // Î∞±ÏóÖ Îã§Ïö¥Î°úÎìú
            document.getElementById('exportBtn')?.addEventListener('click', () => {
                const backupData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    salesData: state.salesData,
                    trendData: state.trendData,
                    columnMapping: columnMapping,
                    newsletters: state.newsletters,
                    subscribers: state.subscribers,
                    settings: {
                        geminiApiKey: state.geminiApiKey,
                        stibeeApiKey: state.stibeeApiKey,
                        stibeeListId: state.stibeeListId
                    }
                };
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `bidbuy_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(a.href);
                showToast(`‚úÖ Î∞±ÏóÖ ÏôÑÎ£å! (ÌåêÎß§Îç∞Ïù¥ÌÑ∞ ${formatNumber(state.salesData.length)}Í±¥, Ìä∏Î†åÎìú ${state.trendData.length}Í∞ú)`, 'success');
            });

            // Î∞±ÏóÖ ÌååÏùº Î≥µÏõê
            document.getElementById('importBtn')?.addEventListener('click', () => {
                document.getElementById('importFileInput')?.click();
            });

            document.getElementById('importFileInput')?.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    const text = await file.text();
                    const backupData = JSON.parse(text);

                    // Î∞±ÏóÖ ÌååÏùº Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                    if (!backupData.salesData && !backupData.trendData) {
                        showToast('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Î∞±ÏóÖ ÌååÏùºÏûÖÎãàÎã§', 'error');
                        return;
                    }

                    const confirmMsg = `Î∞±ÏóÖ ÌååÏùºÏùÑ Î≥µÏõêÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n` +
                        `üìÖ Î∞±ÏóÖ ÎÇ†Ïßú: ${backupData.exportDate ? new Date(backupData.exportDate).toLocaleString() : 'Ïïå Ïàò ÏóÜÏùå'}\n` +
                        `üì¶ ÌåêÎß§ Îç∞Ïù¥ÌÑ∞: ${backupData.salesData?.length || 0}Í±¥\n` +
                        `üî• Ìä∏Î†åÎìú ÌÇ§ÏõåÎìú: ${backupData.trendData?.length || 0}Í∞ú\n\n` +
                        `‚ö†Ô∏è ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Îäî ÎçÆÏñ¥Ïì∞Í∏∞Îê©ÎãàÎã§.`;

                    if (!confirm(confirmMsg)) return;

                    // Îç∞Ïù¥ÌÑ∞ Î≥µÏõê
                    if (backupData.salesData) {
                        state.salesData = backupData.salesData;
                        await saveSalesData(state.salesData);
                    }
                    if (backupData.trendData) {
                        state.trendData = backupData.trendData;
                        localStorage.setItem('bidbuy_trends', JSON.stringify(state.trendData));
                    }
                    if (backupData.columnMapping) {
                        columnMapping = backupData.columnMapping;
                        localStorage.setItem('bidbuy_column_mapping', JSON.stringify(columnMapping));
                    }
                    if (backupData.newsletters) {
                        state.newsletters = backupData.newsletters;
                        localStorage.setItem('bidbuy_newsletters', JSON.stringify(state.newsletters));
                    }
                    if (backupData.settings) {
                        if (backupData.settings.geminiApiKey) {
                            state.geminiApiKey = backupData.settings.geminiApiKey;
                            localStorage.setItem('bidbuy_gemini_key', state.geminiApiKey);
                        }
                        if (backupData.settings.stibeeApiKey) {
                            state.stibeeApiKey = backupData.settings.stibeeApiKey;
                            localStorage.setItem('bidbuy_stibee_key', state.stibeeApiKey);
                        }
                        if (backupData.settings.stibeeListId) {
                            state.stibeeListId = backupData.settings.stibeeListId;
                            localStorage.setItem('bidbuy_stibee_list', state.stibeeListId);
                        }
                    }

                    window._analyzedOnce = false;
                    render();
                    showToast(`‚úÖ Î≥µÏõê ÏôÑÎ£å! (ÌåêÎß§Îç∞Ïù¥ÌÑ∞ ${formatNumber(state.salesData.length)}Í±¥, Ìä∏Î†åÎìú ${state.trendData.length}Í∞ú)`, 'success');
                } catch (err) {
                    console.error('Î≥µÏõê Ïò§Î•ò:', err);
                    showToast('Î∞±ÏóÖ ÌååÏùº Î≥µÏõê Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + err.message, 'error');
                }

                // ÌååÏùº ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
                e.target.value = '';
            });

            // ÏóÖÎ°úÎìú Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî (API ÌÇ§Îäî Ïú†ÏßÄ)
            document.getElementById('resetBtn')?.addEventListener('click', async () => {
                const confirmMsg = `‚ö†Ô∏è ÏóÖÎ°úÎìúÎêú Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n` +
                    `ÏÇ≠Ï†úÎê† Ìï≠Î™©:\n` +
                    `‚Ä¢ ÌåêÎß§ Îç∞Ïù¥ÌÑ∞: ${formatNumber(state.salesData.length)}Í±¥\n` +
                    `‚Ä¢ Ìä∏Î†åÎìú ÌÇ§ÏõåÎìú: ${state.trendData.length}Í∞ú\n` +
                    `‚Ä¢ Ïª¨Îüº Îß§Ìïë ÏÑ§Ï†ï\n` +
                    `‚Ä¢ ÏÉùÏÑ±Îêú Îâ¥Ïä§Î†àÌÑ∞\n\n` +
                    `‚úì API ÌÇ§ ÏÑ§Ï†ïÏùÄ Ïú†ÏßÄÎê©ÎãàÎã§.\n\n` +
                    `‚ùå Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§!`;

                if (!confirm(confirmMsg)) return;

                try {
                    // IndexedDB ÏÇ≠Ï†ú
                    await saveSalesData([]);

                    // ÏóÖÎ°úÎìú Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ†® LocalStorageÎßå ÏÇ≠Ï†ú (API ÌÇ§Îäî Ïú†ÏßÄ)
                    localStorage.removeItem('bidbuy_trends');
                    localStorage.removeItem('bidbuy_column_mapping');
                    localStorage.removeItem('bidbuy_newsletters');

                    // State Ï¥àÍ∏∞Ìôî (API ÌÇ§Îäî Ïú†ÏßÄ)
                    state.salesData = [];
                    state.trendData = [];
                    state.newsletters = [];
                    state.newsletterHtml = '';
                    state.generatedContent = '';
                    columnMapping = { product: null, category: null, sales: null, site: null, date: null, category1: null, category2: null, category3: null, category4: null };
                    selectedMonth = null;

                    showToast('‚úÖ ÏóÖÎ°úÎìú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§ (API ÌÇ§Îäî Ïú†ÏßÄ)', 'success');
                    window._analyzedOnce = false;
                    render();
                } catch (err) {
                    console.error('Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', err);
                    showToast('Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•ò Î∞úÏÉù: ' + err.message, 'error');
                }
            });
        }

        function setUploadStatus(show, text = '') {
            const statusEl = document.getElementById('uploadStatus');
            const textEl = document.getElementById('uploadStatusText');
            if (statusEl) {
                statusEl.style.display = show ? 'block' : 'none';
                if (textEl && text) textEl.textContent = text;
            }
        }

        async function handleFileUpload(file) {
            console.log('üöÄ ÌååÏùº ÏóÖÎ°úÎìú ÏãúÏûë');

            // ÌååÏùº Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            if (!file) {
                showToast('ÌååÏùºÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî', 'error');
                return;
            }

            const fileName = file.name;
            const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
            console.log('üìÅ ÏóÖÎ°úÎìú ÌååÏùº:', fileName, file.type, fileSizeMB + 'MB');

            const ext = fileName.split('.').pop().toLowerCase();
            console.log('üìÑ ÌååÏùº ÌôïÏû•Ïûê:', ext);

            // ÌïúÍ∏Ä ÌååÏùºÎ™ÖÎèÑ Ï†ïÏÉÅ Ï≤òÎ¶¨Îê®
            console.log('üìù ÌååÏùºÎ™Ö (Ïù∏ÏΩîÎî© ÌôïÏù∏):', encodeURIComponent(fileName));

            if (!['xlsx', 'xls', 'csv'].includes(ext)) {
                showToast('ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÌååÏùº ÌòïÏãùÏûÖÎãàÎã§. (xlsx, xls, csvÎßå Í∞ÄÎä•)', 'error');
                return;
            }

            // ÎåÄÏö©Îüâ ÌååÏùº Í≤ΩÍ≥† (50MBÎ°ú ÌôïÎåÄ)
            if (file.size > 50 * 1024 * 1024) {
                showToast('ÌååÏùº ÌÅ¨Í∏∞Í∞Ä ÎÑàÎ¨¥ ÌÅΩÎãàÎã§. (ÏµúÎåÄ 50MB)', 'error');
                return;
            }

            // ÏßÑÌñâ ÏÉÅÌÉú ÌëúÏãú
            setUploadStatus(true, `üìÇ ${fileName} (${fileSizeMB}MB) Î∂ÑÏÑù Ï§ë...`);

            try {
                console.log('‚è≥ ÌååÏã± ÏãúÏûë...');
                const startTime = Date.now();

                const data = await parseExcel(file);

                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                console.log(`‚úÖ ÌååÏã± ÏôÑÎ£å: ${data.length}Í±¥, ${elapsed}Ï¥à ÏÜåÏöî`);

                setUploadStatus(false);

                // IndexedDB ÏÇ¨Ïö©ÏúºÎ°ú ÎåÄÏö©Îüâ Îç∞Ïù¥ÌÑ∞ ÏßÄÏõê (ÏµúÎåÄ 100ÎßåÍ±¥)
                state.salesData = data;
                showToast(`üìä ${formatNumber(data.length)}Í±¥ Î°úÎìú ÏôÑÎ£å (${elapsed}Ï¥à), Ï†ÄÏû• Ï§ë...`);

                // Ïª¨Îüº ÏûêÎèô Í∞êÏßÄ
                detectColumns(data);

                // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Ìä∏Î†åÎìú ÌÇ§ÏõåÎìú Ï∂îÏ∂ú (TOP 30)
                console.log('üìä Ìä∏Î†åÎìú ÌÇ§ÏõåÎìú Ï∂îÏ∂ú ÏãúÏûë...');
                const extractedTrends = extractTrendFromData();
                if (extractedTrends.length > 0) {
                    state.trendData = extractedTrends;
                    localStorage.setItem('bidbuy_trends', JSON.stringify(state.trendData));
                    console.log('‚úÖ Ìä∏Î†åÎìú ÌÇ§ÏõåÎìú Ï∂îÏ∂ú ÏôÑÎ£å:', extractedTrends.length, 'Í∞ú');
                }

                // IndexedDBÏóê Ï†ÄÏû• ÏãúÎèÑ (ÎåÄÏö©Îüâ ÏßÄÏõê)
                try {
                    const savedCount = await saveSalesData(data);
                    saveState(); // Ìä∏Î†åÎìú, Îâ¥Ïä§Î†àÌÑ∞ Îì± Í∏∞ÌÉÄ Îç∞Ïù¥ÌÑ∞
                    showToast(`‚úÖ ${formatNumber(savedCount || data.length)}Í±¥ Ï†ÄÏû• ÏôÑÎ£å!`, 'success');
                } catch (storageErr) {
                    console.error('‚ùå IndexedDB Ï†ÄÏû• Ïã§Ìå®:', storageErr);
                    console.error('ÏóêÎü¨ ÏÉÅÏÑ∏:', storageErr.name, storageErr.message);
                    // Ï†ÄÏû• Ïã§Ìå®Ìï¥ÎèÑ Î©îÎ™®Î¶¨ÏóêÎäî Ïú†ÏßÄ
                    showToast(`‚ö†Ô∏è ÏòÅÍµ¨ Ï†ÄÏû• Ïã§Ìå® (ÏÉàÎ°úÍ≥†Ïπ® Ïãú ÏÇ¨ÎùºÏßê) - Î∂ÑÏÑùÏùÄ Í∞ÄÎä•Ìï©ÎãàÎã§`, 'error');
                }

                render();

                // Ïª¨Îüº Îß§Ìïë Í≤∞Í≥º ÏïåÎ¶º
                const mapped = Object.entries(columnMapping).filter(([k,v]) => v).map(([k,v]) => `${k}‚Üí${v}`).join(', ');
                if (mapped) {
                    console.log('‚úÖ ÏûêÎèô Îß§Ìïë:', mapped);
                } else {
                    showToast('‚ö†Ô∏è Ïª¨ÎüºÏùÑ ÏûêÎèô Ïù∏ÏãùÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§. Ïª¨Îüº ÏÑ§Ï†ïÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî', 'error');
                }
            } catch (err) {
                console.error('‚ùå File upload error:', err);
                setUploadStatus(false);
                showToast('Ïò§Î•ò: ' + err.message, 'error');
            }
        }

        function buildPrompt(type) {
            // Ïã§Ï†ú ÌåêÎß§ Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù
            const { stats, totalSales, totalQty, topProducts, productCount } = analyzeCategories();
            const sortedCats = Object.entries(stats).sort((a, b) => b[1].sales - a[1].sales).slice(0, 5);

            // Ìä∏Î†åÎìú Îç∞Ïù¥ÌÑ∞
            const top5Trends = state.trendData.slice(0, 5);

            // Îç∞Ïù¥ÌÑ∞ Ïª®ÌÖçÏä§Ìä∏ Íµ¨ÏÑ±
            let dataContext = `
[Î∂ÑÏÑù Í∏∞Í∞Ñ] ${state.weekInfo.month}Ïõî ${state.weekInfo.week}Ï£ºÏ∞®
[Ï¥ù ÌåêÎß§ ÌòÑÌô©]
- Ï¥ù ÌåêÎß§Í∏àÏï°: ${formatNumber(totalSales)}Ïõê
- Ï¥ù ÌåêÎß§ÏàòÎüâ: ${formatNumber(totalQty)}Í∞ú
- Î∂ÑÏÑù ÏÉÅÌíà Ïàò: ${formatNumber(productCount)}Í∞ú
`;

            if (sortedCats.length > 0) {
                dataContext += `
[Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ TOP 5 ÌåêÎß§]
${sortedCats.map(([cat, data], i) => `${i+1}. ${cat}: ${formatNumber(data.sales)}Ïõê (${data.ratio}%, ${formatNumber(data.quantity)}Í∞ú)`).join('\n')}
`;
            }

            if (topProducts && topProducts.length > 0) {
                dataContext += `
[Ïù∏Í∏∞ ÏÉÅÌíà TOP 5]
${topProducts.slice(0, 5).map((p, i) => `${i+1}. ${p.name} (${p.category}): ${formatNumber(p.sales)}Ïõê, ${formatNumber(p.quantity)}Í∞ú`).join('\n')}
`;
            }

            if (top5Trends.length > 0) {
                dataContext += `
[Ìä∏Î†åÎìú ÌÇ§ÏõåÎìú TOP 5]
${top5Trends.map((t, i) => `${i+1}. ${t.keyword} (${t.category}) - Í≤ÄÏÉâ ${formatNumber(t.searches)}Í±¥, ${t.change >= 0 ? '+' : ''}${t.change}%`).join('\n')}
`;
            }

            const prompts = {
                newsletter: `ÎãπÏã†ÏùÄ ÎπÑÎìúÎ∞îÏù¥ÏΩîÎ¶¨ÏïÑ(ÏùºÎ≥∏ Íµ¨Îß§ÎåÄÌñâ ÏÑúÎπÑÏä§)Ïùò ÎßàÏºÄÌåÖ Îã¥ÎãπÏûêÏûÖÎãàÎã§.
ÏïÑÎûò Ïã§Ï†ú ÌåêÎß§ Îç∞Ïù¥ÌÑ∞Î•º Î∂ÑÏÑùÌïòÏó¨ Í≥†Í∞ùÏóêÍ≤å Î≥¥ÎÇº Îâ¥Ïä§Î†àÌÑ∞Î•º ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.

${dataContext}

[ÏûëÏÑ± Í∞ÄÏù¥ÎìúÎùºÏù∏]
- ÌÜ§: ÏπúÍ∑ºÌïòÎ©¥ÏÑúÎèÑ Ï†ÑÎ¨∏Ï†Å
- Í∏∏Ïù¥: 400~500Ïûê
- Ïù¥Î™®ÏßÄÎ•º Ï†ÅÏ†àÌûà ÌôúÏö©
- Ïù∏Í∏∞ ÏÉÅÌíàÍ≥º Ìä∏Î†åÎìúÎ•º ÏûêÏó∞Ïä§ÎüΩÍ≤å ÏÜåÍ∞ú
- ÏùºÎ≥∏ Íµ¨Îß§ÎåÄÌñâÏùò Ïû•Ï†ê Í∞ïÏ°∞
- ÎßàÏßÄÎßâÏóê ÌñâÎèô Ïú†ÎèÑ(CTA) Ìè¨Ìï®`,

                blog: `ÎãπÏã†ÏùÄ ÏùºÎ≥∏ Íµ¨Îß§ÎåÄÌñâ Ï†ÑÎ¨∏ Î∏îÎ°úÍ±∞ÏûÖÎãàÎã§.
ÏïÑÎûò ÌåêÎß§ Îç∞Ïù¥ÌÑ∞Î•º Î∞îÌÉïÏúºÎ°ú SEO ÏµúÏ†ÅÌôîÎêú Î∏îÎ°úÍ∑∏ Ìè¨Ïä§Ìä∏Î•º ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.

${dataContext}

[ÏûëÏÑ± Í∞ÄÏù¥ÎìúÎùºÏù∏]
- Îß§Î†•Ï†ÅÏù∏ Ï†úÎ™© Ìè¨Ìï® (ÌÇ§ÏõåÎìú Ìè¨Ìï®)
- Í∏∏Ïù¥: 800~1000Ïûê
- ÏÜåÏ†úÎ™©ÏúºÎ°ú Íµ¨Ï°∞Ìôî
- Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò Ïù∏ÏÇ¨Ïù¥Ìä∏ Ï†úÍ≥µ
- ÏùºÎ≥∏ ÏßÅÍµ¨ ÌåÅ Ìè¨Ìï®
- ÏûêÏó∞Ïä§Îü¨Ïö¥ ÏÉÅÌíà Ï∂îÏ≤ú`,

                sns: `ÎãπÏã†ÏùÄ ÎπÑÎìúÎ∞îÏù¥ÏΩîÎ¶¨ÏïÑÏùò SNS Îã¥ÎãπÏûêÏûÖÎãàÎã§.
ÏïÑÎûò Îç∞Ïù¥ÌÑ∞Î•º Î∞îÌÉïÏúºÎ°ú Ïù∏Ïä§ÌÉÄÍ∑∏Îû® ÌîºÎìúÏö© Ìè¨Ïä§Ìä∏Î•º ÏûëÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.

${dataContext}

[ÏûëÏÑ± Í∞ÄÏù¥ÎìúÎùºÏù∏]
- Í∏∏Ïù¥: 150~200Ïûê
- ÎààÍ∏∏ÏùÑ ÎÅÑÎäî Ï≤´ Î¨∏Ïû•
- Ïù¥Î™®ÏßÄ Ï†ÅÍ∑π ÌôúÏö©
- Í¥ÄÎ†® Ìï¥ÏãúÌÉúÍ∑∏ 7~10Í∞ú Ìè¨Ìï®
- ÌñâÎèô Ïú†ÎèÑ Î¨∏Íµ¨`
            };
            return prompts[type] || prompts.newsletter;
        }

        // Ïï± Ï¥àÍ∏∞Ìôî (IndexedDBÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú)
        async function initApp() {
            console.log('üöÄ Ïï± Ï¥àÍ∏∞Ìôî ÏãúÏûë...');

            try {
                // IndexedDB Ï¥àÍ∏∞Ìôî
                await initDB();

                // ÌåêÎß§ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
                const salesData = await loadSalesData();
                if (salesData && salesData.length > 0) {
                    state.salesData = salesData;
                    console.log(`‚úÖ ${formatNumber(salesData.length)}Í±¥Ïùò ÌåêÎß§ Îç∞Ïù¥ÌÑ∞ Î°úÎìúÎê®`);

                    // Ïª¨Îüº Îß§Ìïë ÌôïÏù∏
                    loadColumnMapping();
                    if (!columnMapping.category1 && !columnMapping.sales) {
                        detectColumns(salesData);
                    }

                    // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞ò Ìä∏Î†åÎìú Ï∂îÏ∂ú (ÏÉòÌîå Îç∞Ïù¥ÌÑ∞ ÎåÄÏ≤¥)
                    const extractedTrends = extractTrendFromData();
                    if (extractedTrends.length > 0) {
                        state.trendData = extractedTrends;
                        localStorage.setItem('bidbuy_trends', JSON.stringify(state.trendData));
                        console.log(`‚úÖ Ìä∏Î†åÎìú ÌÇ§ÏõåÎìú Ï∂îÏ∂ú ÏôÑÎ£å: ${extractedTrends.length}Í∞ú`);
                    }
                }
            } catch (err) {
                console.warn('‚ö†Ô∏è IndexedDB Î°úÎìú Ïã§Ìå®, Îπà ÏÉÅÌÉúÎ°ú ÏãúÏûë:', err);
            }

            state.isLoading = false;
            saveState(); // Ìä∏Î†åÎìú, Íµ¨ÎèÖÏûê Îì± Ï†ÄÏû•
            render();
            console.log('‚úÖ Ïï± Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
        }

        // Ïï± ÏãúÏûë
        initApp();
    </script>
</body>
</html>
